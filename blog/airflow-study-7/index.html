<!doctype html><html lang=ko-kr dir=ltr><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><meta name=keywords content="Apache Airflow,Connection,Hook,Docker Compose,Postgres,Custom Hook,데이터 엔지니어링,에어플로우,Python,Study"><meta name=description content="Apache Airflow의 Connection과 Hook 개념을 소개하고, Docker Compose를 활용한 Postgres 컨테이너 생성부터 Connection 설정, …"><meta name=author content="minyeamer"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><link rel=canonical href=https://minyeamer.github.io/blog/airflow-study-7/><link rel=icon href=https://minyeamer.github.io/images/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://minyeamer.github.io/images/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://minyeamer.github.io/images/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://minyeamer.github.io/images/favicons/apple-touch-icon.png><link rel=mask-icon href=https://minyeamer.github.io/images/favicons/apple-touch-icon.png><meta name=google-site-verification content="u1tWcHmHUZWfFT1cHaku6sqU-bK40N3WLR-C-4VUWN0"><meta name=naver-site-verification content="6eaf8e9da1a6104780f056f1a7797fe5a3a5a0da"><meta property="og:title" content="Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)"><meta property="og:description" content="Apache Airflow의 Connection과 Hook 개념을 소개하고, Docker Compose를 활용한 Postgres 컨테이너 생성부터 Connection 설정, …"><meta property="og:type" content="article"><meta property="og:url" content="https://minyeamer.github.io/blog/airflow-study-7/"><meta property="og:image" content="https://dl.dropboxusercontent.com/scl/fi/8oxi6rw0kesl9l3egs78s/airflow-00-cover.webp?rlkey=6abx67jiweasmlwehj4o4gdle&amp;st=n484uuow&amp;dl=0"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-08T16:52:44+09:00"><meta property="article:modified_time" content="2025-06-08T16:52:44+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dl.dropboxusercontent.com/scl/fi/8oxi6rw0kesl9l3egs78s/airflow-00-cover.webp?rlkey=6abx67jiweasmlwehj4o4gdle&amp;st=n484uuow&amp;dl=0"><meta name=twitter:title content="Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)"><meta name=twitter:description content="Apache Airflow의 Connection과 Hook 개념을 소개하고, Docker Compose를 활용한 Postgres 컨테이너 생성부터 Connection 설정, …"><meta name=twitter:site content="@https://x.com/minyeamer"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minyeamer.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)","item":"https://minyeamer.github.io/blog/airflow-study-7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)","name":"Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)","description":"Apache Airflow의 Connection과 Hook 개념을 소개하고, Docker Compose를 활용한 Postgres 컨테이너 생성부터 Connection 설정, Hook 사용, bulk_load 기능까지 단계별로 안내합니다. Docker Compose, Postgres, Connection, Hook, bulk_load까지 다룹니다.\n","keywords":["Apache Airflow","Connection","Hook","Docker Compose","Postgres","Custom Hook","데이터 엔지니어링","에어플로우","Python","Study"],"articleBody":"Docker Compose 이해 # 목적 : 1개 이상의 도커 컨테이너 생성 시 컨테이너들의 설정을 관리할 수 있도록 해주는 기능 방법 : docker-compose.yaml 파일에 컨테이너들의 설정을 입력 사용 : .yaml 파일이 있는 위치에서 docker compose up 명령어를 입력하여 실행 yaml 파일은 들여쓰기 문법을 사용하며 Airflow의 Docker Compose는 아래와 같이 구분 Copy yaml x-airflow-common: # 각 서비스에 공통 적용될 항목들 services: # 컨테이너로 실행할 서비스를 정의 volumns: # 컨테이너에 연결할 볼륨을 정의 networks: # 컨테이너에 연결할 네트워크를 정의 x-airflow-common\n공통으로 사용할 항목을 \u0026 를 붙여서 지정 \u0026 아래의 모든 영역은 공통 항목으로 묶여 한번에 가져올 수 있음 Copy yaml x-airflow-common: \u0026airflow-common image: ${AIRFLOW_IMAGE_NAME:-apache/airflow:3.0.1} environment: \u0026airflow-common-env AIRFLOW__CORE__EXECUTOR: CeleryExecutor services\n컨테이너로 올릴 서비스 목록을 지정 공통 항목을 \u003c\u003c: *airflow-common 과 같은 형식으로 불러오기 환경 변수가 있을 경우 environment 아래에 입력 ports 는 호스트에서 컨테이너에 접속하기 위해 맵핑할 포트를 명시 expose 는 ports 와 다르게 내부 컨테이너 간에 연결할 때 사용할 포트를 명시 depends_on 은 컨테이너의 실행 순서를 정의 airflow-apiserver 는 airflow-init 에 대한 종속적 관계 Copy yaml services: airflow-apiserver: \u003c\u003c: *airflow-common command: api-server ports: - \"8080:8080\" healthcheck: test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:8080/api/v2/version\"] interval: 30s timeout: 10s retries: 5 start_period: 30s restart: always depends_on: \u003c\u003c: *airflow-common-depends-on airflow-init: condition: service_completed_successfully volumes\n컨테이너 내 데이터를 유지하기 위해 외부와 연결하기 위한 볼륨 정보 볼륨 리스트를 보려면 docker volume ls 명령어 사용 Copy yaml volumes: postgres-db-volume: 서비스를 정의할 때 생성한 볼륨과 컨테이너의 내부 경로를 연결 가능 Copy yaml services: postgres: volumes: - postgres-db-volume:/var/lib/postgresql/data networks\n컨테이너를 격리된 네트워크로 그룹화하기 위한 네트워크 정보 컨테이너는 유동 IP를 가지게 되어 재가동할 때마다 IP 주소가 변경될 수 있는데, 고정 IP를 할당하기 위해 networks 활용 가능 네트워크 리스트를 보려면 docker network ls 명령어 사용 Copy yaml networks: network_custom: driver: bridge ipam: driver: default config: - subnet: 172.28.0.0/16 gateway: 172.28.0.1 Airflow에서 기본적으로 사용하는 airflow_default 네트워크 대역이 172.18.0.0/16 서브넷 범위인데, 아래에서 새 컨테이너를 만들기 위해 겹치지 않는 대역의 network_custom 을 정의 Copy bash % docker network inspect {network_id} [ { \"Name\": \"airflow_default\", ... \"IPAM\": { \"Driver\": \"default\", \"Options\": null, \"Config\": [ { \"Subnet\": \"172.18.0.0/16\", \"Gateway\": \"172.18.0.1\" } ] }, ... } ] Postgres 컨테이너 생성 # Docker Compose # Airflow에서 기본으로 사용하는 Postgres 컨테이너 외에 새로운 Postgres 컨테이너 하나를 추가로 생성 DB 사용자에 대한 정보는 환경 변수 environment 로 입력 5432 포트로 접속할 수 있게 포트 맵핑 적용 기존의 postgres 컨테이너도 5431 포트로 접속할 수 있게 마찬가지로 포트 맵핑 적용 postgres-custom-db-volume 볼륨을 추가하고 컨테이너 내부 경로와 연결 위에서 정의한 network_custom 네트워크에 연결하면서 IP 주소는 172.28.0.3 으로 고정 다른 컨테이너에도 network_custom 및 겹치지 않는 고정 IP 주소를 할당 Copy yaml services: postgres_custom: image: postgres:13 environment: POSTGRES_USER: minyeamer POSTGRES_PASSWORD: minyeamer POSGRES_DB: minyeamer TZ: Asia/Seoul volumes: - postgres-custom-db-volume:/var/lib/postgresql/data ports: - 5432:5432 networks: network_custom: ipv4_address: 172.28.0.3 postgres: image: postgres:13 ... ports: - 5431:5432 networks: network_custom: ipv4_address: 172.28.0.4 ... volumes: postgres-db-volume: postgres-custom-db-volume: networks: network_custom: ... 실행 후 컨테이너 목록을 조회하면 airflow-postgres_custom-1 명칭의 컨테이너가 같이 올라온 것을 확인 Copy bash % docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 72541e89bff4 apache/airflow:3.0.1 \"/usr/bin/dumb-init …\" 57 seconds ago Up 20 seconds (healthy) 8080/tcp airflow-airflow-worker-1 1735bc475bff apache/airflow:3.0.1 \"/usr/bin/dumb-init …\" 57 seconds ago Up 36 seconds (healthy) 0.0.0.0:8080-\u003e8080/tcp airflow-airflow-apiserver-1 d2b680f273e3 apache/airflow:3.0.1 \"/usr/bin/dumb-init …\" 57 seconds ago Up 36 seconds (healthy) 8080/tcp airflow-airflow-scheduler-1 f23c6d30d22c apache/airflow:3.0.1 \"/usr/bin/dumb-init …\" 57 seconds ago Up 36 seconds (healthy) 8080/tcp airflow-airflow-dag-processor-1 09992f09ac5e apache/airflow:3.0.1 \"/usr/bin/dumb-init …\" 57 seconds ago Up 36 seconds (healthy) 8080/tcp airflow-airflow-triggerer-1 5c1b13f33229 postgres:13 \"docker-entrypoint.s…\" 58 seconds ago Up 56 seconds 0.0.0.0:5432-\u003e5432/tcp airflow-postgres_custom-1 e23d4eb919fc postgres:13 \"docker-entrypoint.s…\" 58 seconds ago Up 56 seconds (healthy) 0.0.0.0:5431-\u003e5432/tcp airflow-postgres-1 86fc82a16953 redis:7.2-bookworm \"docker-entrypoint.s…\" 58 seconds ago Up 56 seconds (healthy) 6379/tcp airflow-redis-1 DBeaver 접속 # Beaver Community 버전을 다운로드 및 설치한 후 실행 좌측 상단의 New Database Connection 을 클릭해 PostgreSQL 연결을 생성 Port는 Docker Compose에서 맵핑한 5432 사용 Database, Username, Password 또한 Docker Compose에서 지정한 값을 사용 정상적으로 연결되었다면 아래와 같이 Database 명칭을 확인 가능 Postgres 테이블 생성 # PythonOperator 를 사용해 새로 생성한 PostgreSQL 컨테이너에 임의의 값을 INSERT 하는 작업을 구현하기 전에, 아래와 같이 public.dag_run 테이블을 생성 Copy sql CREATE TABLE public.dag_run ( dag_id varchar(100) NULL, task_id varchar(100) NULL, run_id varchar(100) NULL, msg text NULL ); 테이블이 정상적으로 만들어졌다면 새로고침 후 아래와 같이 테이블 내 컬럼 내역을 확인 가능 PythonOperator # PostgreSQL에 연결해 현재 실행 정보를 INSERT INTO 로 추가하는 함수 insert_into_postgres() 를 실행 DB 연결 시 conn 세션 객체 생성 후 .close() 로 종료하는 구문을 closing 으로 대체 DB 세션에서 쿼리를 실행하는 cursor 객체를 만들고 해당 객체를 통해 SQL문을 수행 함수에 인수로 전달하는 DB 연결 정보는 마찬가지로 Docker Compose에서 지정한 값을 사용 Copy python # dags/python_with_postgres.py from airflow.sdk import DAG from airflow.providers.standard.operators.python import PythonOperator import pendulum with DAG( dag_id=\"python_with_postgres\", schedule=None, start_date=pendulum.datetime(2025, 1, 1, tz=\"Asia/Seoul\"), catchup=False, tags=[\"example\", \"hook\"], ) as dag: def insert_into_postgres(ip: str, port: str, dbname: str, user: str, passwd: str, **kwargs): import psycopg2 from contextlib import closing with closing(psycopg2.connect(host=ip, dbname=dbname, user=user, password=passwd, port=int(port))) as conn: with closing(conn.cursor()) as cursor: dag_id = kwargs.get(\"ti\").dag_id task_id = kwargs.get(\"ti\").task_id run_id = kwargs.get(\"ti\").run_id msg = \"INSERT INTO 수행\" sql = \"INSERT INTO dag_run VALUES (%s,%s,%s,%s);\" cursor.execute(sql,(dag_id,task_id,run_id,msg)) conn.commit() postgres_task = PythonOperator( task_id=\"postgres_task\", python_callable=insert_into_postgres, op_args=[\"172.28.0.3\", \"5432\", \"minyeamer\", \"minyeamer\", \"minyeamer\"] ) DAG을 실행한 후 DBeaver에서 dag_run 테이블 조회 시 아래와 같이 하나의 행이 올라온 것을 확인 문제점 및 해결방법 # 문제점 : DB 접속정보가 노출되고 접속정보가 변경되면 대응하기가 어려움 해결방법 Variable 이용 Hook 이용 Connection \u0026 Hook # Connection : Airflow에서 외부와 연동하기 위해 설정하는 기본 정보 Hook Airflow에서 외부 솔루션의 기능을 사용할 수 있도록 미리 구현된 메서드를 가진 클래스 Connection 정보를 통해 생성되는 객체로, 접속정보가 코드상 노출되지 않음 외부의 특정 솔루션을 다룰 수 있는 메서드가 구현되어 있음 Operator와 같이 Task를 만들어내지는 못하기 때문에 Operator 내 함수에서 사용 Postgres Provider 문서 보기 # apache-airflow-providers-postgres — apache-airflow-providers-postgres …airflow.apache.org Providers에 속한 Postgres 문서에서 Connection 접속 과정을 조회 가능 Copy python def get_conn(self) -\u003e connection: \"\"\"Establish a connection to a postgres database.\"\"\" conn = deepcopy(self.connection) # check for authentication via AWS IAM if conn.extra_dejson.get(\"iam\", False): conn.login, conn.password, conn.port = self.get_iam_token(conn) conn_args = { \"host\": conn.host, \"user\": conn.login, \"password\": conn.password, \"dbname\": self.database or conn.schema, \"port\": conn.port, } raw_cursor = conn.extra_dejson.get(\"cursor\", False) if raw_cursor: conn_args[\"cursor_factory\"] = self._get_cursor(raw_cursor) if self.options: conn_args[\"options\"] = self.options for arg_name, arg_val in conn.extra_dejson.items(): if arg_name not in self.ignored_extra_options: conn_args[arg_name] = arg_val self.conn = psycopg2.connect(**conn_args) return self.conn Connection으로부터 host, login, password, database, port 정보를 읽어서 DB 연결에 대한 파라미터로 활용하는 것을 확인 마지막 줄에는 psycopg2.connect() 연결에 대한 psycopg2.extensions.connection 세션 객체를 반환 Connection 추가 # postgres 타입의 Connection을 새로 생성 연결 정보로 Docker Compose에서 지정한 값을 입력 Connection에 입력한 각 항목은 앞서 확인한 get_conn() 메서드에서 PostgreSQL 연결 시 사용 PostgresHook # Provider 패키지를 설치하고, 기존에 psycopg2 라이브러리로 직접 PostgreSQL에 연결하던 부분을 PostgresHook 으로 변경 Copy bash pip install apache-airflow-providers-postgres Copy python # dags/python_with_postgres_hook.py from airflow.sdk import DAG from airflow.providers.standard.operators.python import PythonOperator import pendulum with DAG( dag_id=\"python_with_postgres_hook\", schedule=None, start_date=pendulum.datetime(2025, 1, 1, tz=\"Asia/Seoul\"), catchup=False, tags=[\"example\", \"hook\"], ) as dag: def insert_into_postgres(postgres_conn_id: str, **kwargs): from airflow.providers.postgres.hooks.postgres import PostgresHook from contextlib import closing postgres_hook = PostgresHook(postgres_conn_id) with closing(postgres_hook.get_conn()) as conn: with closing(conn.cursor()) as cursor: dag_id = kwargs.get(\"ti\").dag_id task_id = kwargs.get(\"ti\").task_id run_id = kwargs.get(\"ti\").run_id msg = \"INSERT INTO 수행\" sql = \"INSERT INTO dag_run VALUES (%s,%s,%s,%s);\" cursor.execute(sql,(dag_id,task_id,run_id,msg)) conn.commit() postgres_task = PythonOperator( task_id=\"postgres_task\", python_callable=insert_into_postgres, op_kwargs={\"postgres_conn_id\":\"conn-db-postgres-custom\"} ) DAG을 실행한 후 DBeaver에서 dag_run 테이블 조회 시 아래와 같이 두 번째 행이 추가된 것을 확인 bulk_load # Postgres Provider 문서 보기 # airflow.providers.postgres.hooks.postgres — apache-airflow-providers-postgres …airflow.apache.org PostgreSQL에 데이터를 업로드하는 bulk_load() 메서드에 대해 살펴보기 Copy python def bulk_load(self, table: str, tmp_file: str) -\u003e None: \"\"\"Load a tab-delimited file into a database table.\"\"\" self.copy_expert(f\"COPY {table} FROM STDIN\", tmp_file) bulk_load() 메서드는 내부적으로 copy_expert() 메서드를 사용하는데, 해당 소스코드를 조회 Copy python def copy_expert(self, sql: str, filename: str) -\u003e None: self.log.info(\"Running copy expert: %s, filename: %s\", sql, filename) if not os.path.isfile(filename): with open(filename, \"w\"): pass with open(filename, \"r+\") as file, closing(self.get_conn()) as conn, closing(conn.cursor()) as cur: cur.copy_expert(sql, file) file.truncate(file.tell()) conn.commit() copy_expert() 메서드는 get_conn() 메서드를 통해 세션 객체를 얻어오고, 세션 객체로부터 cursor 객체를 만들어서 해당 객체가 가지고 있는 copy_expert() 메서드를 수행\nPsycopg 공식 문서에 따르면, copy_expert() 메서드는 file 객체를 전달받아서 COPY TO 문법에 대응되는 SQL문을 실행해 테이블에 업로드 수행\nThe sql statement should be in the form COPY table TO STDOUT to export table to the file object passed as argument or COPY table FROM STDIN to import the content of the file object into table.\nCopy python copy_expert(sql, file, size=8192) Copy python \u003e\u003e\u003e cur.copy_expert(\"COPY test TO STDOUT WITH CSV HEADER\", sys.stdout) id,num,data 1,100,abc'def 2,,dada ... Postgres 테이블 생성 # 저번에 만든 Custom Operator로 가져온 네이버 쇼핑 검색 결과 shop.csv 파일을 PostgreSQL에 업로드할 계획을 가지고 테이블 구조를 정의 CSV 파일과 동일한 열을 TEXT 타입으로 가지는 nshopping.search 테이블을 생성 Copy sql CREATE TABLE nshopping_search( rank text, title text, link text, image text, lprice text, hprice text, mallName text, productId text, productType text, brand text, maker text, category1 text, category2 text, category3 text, category4 text ); DBeaver에서 nshopping 스키마를 만들고 SQL문을 수행하면 아래와 같이 테이블 열 목록을 확인 가능 CSV 파일 가공 # Load a tab-delimited file into a database table.\n앞서 bulk_load() 메서드의 주석에 Tab 으로 구분된 파일을 업로드한다고 명시되어 있기 때문에, shop.csv 파일을 , 대신 Tab 으로 구분한 shop_with_tab.csv 파일을 같은 위치에 생성 vi 편집기로 파일을 열었다면 %s/,/\\t/g 명령어를 입력해 , 를 Tab 으로 변경 가능 ranktitlelinkimagelpricehpricemallNameproductIdproductTypebrandmakercategory1category2category3category4 1삼성 갤럭시북 인강용 사무용 업무용 가성비 윈도우11 저가 싼 태블릿 노트북 추천 기본팩https://smartstore.naver.com/main/products/10407884292https://shopping-phinf.pstatic.net/main_8795238/87952389253.11.jpg428000삼성공식파트너 코인비엠에스879523892532갤럭시북삼성전자디지털/가전노트북2LG전자 울트라PC 라이젠5 사무용 인강용 저렴한 8GB NVMe256GB LG노트북https://smartstore.naver.com/main/products/6174236911https://shopping-phinf.pstatic.net/main_8371873/83718736488.14.jpg599000제이 씨앤에스837187364882LG전자LG전자디지털/가전노트북3LG그램 노트북 14그램 Ultra5 16GB 256GB 인텔Arc GPU 인강용https://smartstore.naver.com/main/products/9091504708https://shopping-phinf.pstatic.net/main_8663600/86636005031.7.jpg1149000온라인총판대리점866360050312LG그램LG전자디지털/가전노트북4삼성전자 갤럭시북4 NT750XGR-A51A 16GB 256GBhttps://search.shopping.naver.com/catalog/52631236642https://shopping-phinf.pstatic.net/main_5263123/52631236642.20250124094900.jpg799000네이버526312366421갤럭시북4삼성전자디지털/가전노트북52025 LG그램 15 Ai 라이젠5 16GB 256GB AMD 포토샵 대학생 인강용 노트북https://smartstore.naver.com/main/products/10133562287https://shopping-phinf.pstatic.net/main_8767806/87678065467.4.jpg1239000창이로운876780654672LG그램LG전자디지털/가전노트북 bulk_load 활용 예시 # PostgresHook 을 사용한 Operator에 이어서 bulk_load() 메서드를 추가 DAG 실행 날짜에 대응되는 디렉토리 아래의 shop_with_tab.csv 파일을 읽어서 nshopping.search 테이블에 업로드될 것을 기대 Copy python from airflow.sdk import DAG from airflow.providers.standard.operators.python import PythonOperator import pendulum with DAG( dag_id=\"python_with_postgres_load\", schedule=None, start_date=pendulum.datetime(2025, 1, 1, tz=\"Asia/Seoul\"), catchup=False, tags=[\"example\", \"hook\"], ) as dag: def bulk_load_postgres(postgres_conn_id: str, table_name: str, file_path: str, **kwargs): from airflow.providers.postgres.hooks.postgres import PostgresHook postgres_hook = PostgresHook(postgres_conn_id) postgres_hook.bulk_load(table_name, file_path) postgres_task = PythonOperator( task_id=\"postgres_task\", python_callable=bulk_load_postgres, op_kwargs={\"postgres_conn_id\":\"conn-db-postgres-custom\", \"table_name\":\"nshopping.search\", \"file_name\":\"/opt/airflow/files/naverSearch/{{data_interval_end.in_timezone(\\\"Asia/Seoul\\\") | ds_nodash }}/shop_with_tab.csv\"} ) DAG을 실행하고 DBeaver에서 nshopping.search 테이블을 조회하면 아래와 같이 CSV 파일이 그대로 올라온 것을 확인 하지만, CSV 헤더가 1행으로 들어가는 문제점이 보임 문제점 및 개선방안 # 문제점 : 구분자가 Tab 으로 고정되어 있고, 헤더까지 포함해서 업로드 됨 개선방안 : Custom Hook을 만들어서 구분자를 입력받고 헤더 포함 여부를 선택받게 함 Custom Hook은 다음 게시글에서 구현 Custom Hook # airflow.hooks.base — Airflow 3.1.3 Documentationairflow.apache.org BaseHook # BaseHook 클래스를 상속받아 직접 만든 Hook을 사용 가능 get_connection()\nConnection 객체를 가져오는 메서드 classmethod 로 설정되어 있어 객체화하지 않고도 호출 가능 Copy python @classmethod def get_connection(cls, conn_id: str) -\u003e Connection: \"\"\" Get connection, given connection id. :param conn_id: connection id :return: connection \"\"\" from airflow.models.connection import Connection conn = Connection.get_connection_from_secrets(conn_id) log.info(\"Connection Retrieved '%s'\", conn.conn_id) return conn get_hook()\nConnection 객체로부터 Hook 객체를 반환하는 메서드 classmethod 로 설정되어 있어 객체화하지 않고도 호출 가능 Copy python @classmethod def get_hook(cls, conn_id: str, hook_params: dict | None = None) -\u003e BaseHook: \"\"\" Return default hook for this connection id. :param conn_id: connection id :param hook_params: hook parameters :return: default hook for this connection \"\"\" connection = cls.get_connection(conn_id) return connection.get_hook(hook_params=hook_params) get_conn()\nHook 객체에 대한 연결을 구현하는 메서드로, 반드시 재정의해야 함 Copy python def get_conn(self) -\u003e Any: \"\"\"Return connection for the hook.\"\"\" raise NotImplementedError() PostgresHook 개선점 파악 # 이전에 만들었던 네이버 쇼핑 검색 결과에 대한 CSV 파일을 적재하는 PostgresHook의 기능을 개선\n구분자가 Tab 으로 고정되어 있고, 헤더까지 포함해서 업로드 됨 Psycopg 공식 문서에 따르면, CSV HEADER 구문을 뒤에 붙여 헤더를 제외할 수 있음 또한, COPY 문 뒤에 DELIMITER 구문을 추가해 구분자를 지정할 수도 있음 테이블이 없으면 에러가 발생함, 또한 직접 테이블을 생성하는 것도 불편함 CSV 파일의 헤더를 읽어서 CREATE TABLE 문을 만들고, 위 COPY 문 앞에 붙여서 테이블 생성 또한, 더 정확한 테이블 구성을 위해 모든 열을 text 타입으로 지정하지 않고, CSV 파일의 전체 또는 일부를 읽어서 int4 타입의 열을 추측할 수 있을 것이라 판단 기존엔 데이터를 계속해서 추가했는데, 덮어쓰기 옵션을 통해 이전 데이터를 지울 수도 있으면 더 좋을 것이라 생각함 Hook 기능 정의 # CSV 파일을 PostgreSQL 테이블에 적재하는데, 테이블이 없으면 생성하고, 덮어쓰기도 허용\nCustomPostgresHook # BaseHook 을 상속받는 CustomPostgresHook 를 구현 기본적인 구성은 Postgres Provider 문서에서 제공하는 소스코드를 참고 Hook 재사용을 위해 plugins/ 경로 아래에 추가 Copy python # plugins/hooks/postgres.py from airflow.hooks.base import BaseHook from typing import Literal import psycopg2 class CustomPostgresHook(BaseHook): def __init__(self, postgres_conn_id: str, **kwargs): self.postgres_conn_id = postgres_conn_id self.conn = None self.database = kwargs.get(\"database\") def get_conn(self) -\u003e psycopg2.extensions.connection: conn = BaseHook.get_connection(self.postgres_conn_id) conn_args = { \"host\": conn.host, \"user\": conn.login, \"password\": conn.password, \"dbname\": self.database or conn.schema, \"port\": conn.port, } self.conn = psycopg2.connect(**conn_args) return self.conn def bulk_load(self, table: str, filename: str, encoding=\"utf-8\", if_exists: Literal[\"append\",\"replace\"]=\"append\", sep=',', with_header=True): create = self._create_table_sql(table, filename, encoding, sep, with_header) replace = \"TRUNCATE TABLE {};\".format(table) if if_exists == \"replace\" else str() copy = \"COPY {} FROM STDIN DELIMITER '{}' {};\".format(table, sep, (\"CSV HEADER\" if with_header else \"CSV\")) sql = ''.join([create, replace, copy]) self.copy_expert(sql, filename, encoding) def _create_table_sql(self, table: str, filename: str, encoding=\"utf-8\", sep=',', with_header=True) -\u003e str: if with_header: column_list = self._read_csv_column_list(filename, encoding, sep) return \"CREATE TABLE IF NOT EXISTS {}({});\".format(table, column_list) else: return str() def _read_csv_column_list(self, filename: str, encoding=\"utf-8\", sep=',') -\u003e str: import csv def is_int4_type(value: str) -\u003e bool: return (not value) or (value.isdigit() and (-2147483648 \u003c= int(value) \u003c= 2147483647)) with open(filename, \"r+\", encoding=encoding) as file: reader = csv.reader(file, delimiter=sep) header = next(reader) dtypes = [all(map(is_int4_type, values)) for values in zip(*[next(reader) for _ in range(5)])] return \", \".join([\"{} {}\".format(col, (\"int4\" if is_int4 else \"text\")) for col, is_int4 in zip(header, dtypes)]) def copy_expert(self, sql: str, filename: str, encoding=\"utf-8\") -\u003e None: from contextlib import closing self.log.info(\"Running copy expert: %s, filename: %s\", sql, filename) with open(filename, \"r+\", encoding=encoding) as file, closing(self.get_conn()) as conn, closing(conn.cursor()) as cur: cur.copy_expert(sql, file) file.truncate(file.tell()) conn.commit() PostgreSQL 연결 메서드 # get_conn()\nPostgresHook 의 get_conn() 메서드와 유사한데, 메서드를 호출할 때마다 Connection 객체를 가져와 연결 정보를 읽어오는데 차이가 있음 psycopg2 라이브러리를 사용해 PostgreSQL에 연결하고 psycopg2.extensions.connection 객체를 반환 Copy python def get_conn(self) -\u003e psycopg2.extensions.connection: conn = BaseHook.get_connection(self.postgres_conn_id) conn_args = { \"host\": conn.host, \"user\": conn.login, \"password\": conn.password, \"dbname\": self.database or conn.schema, \"port\": conn.port, } self.conn = psycopg2.connect(**conn_args) return self.conn 쿼리문 생성 메서드 # bulk_load()\nf\"COPY {table} FROM STDIN\" 형식의 단순한 SQL문을 사용하던 기존 bulk_load() 메서드를 개선 create : _create_table_sql() 메서드를 통해 CREATE TABLE 문 생성 replace : if_exists 파라미터 값에 따라 테이블 내용을 모두 삭제하는 구문을 선택적으로 추가 copy : 구분자 또는 헤더 포함 여부 등을 파라미터로 받고 이를 활용하여 COPY 문 생성 Copy python def bulk_load(self, table: str, filename: str, encoding=\"utf-8\", if_exists: Literal[\"append\",\"replace\"]=\"append\", sep=',', with_header=True): create = self._create_table_sql(table, filename, encoding, sep, with_header) replace = \"TRUNCATE TABLE {};\".format(table) if if_exists == \"replace\" else str() copy = \"COPY {} FROM STDIN DELIMITER '{}' {};\".format(table, sep, (\"CSV HEADER\" if with_header else \"CSV\")) sql = ''.join([create, replace, copy]) self.copy_expert(sql, filename, encoding) _create_table_sql()\n헤더가 있을 경우에 한정해, _read_csv_column_list() 메서드를 통해 열 목록을 가져오고, CREATE TABLE 문 안에 열 목록을 포맷팅해 반환 IF NOT EXISTS 구문을 추가해 테이블이 이미 존재할 경우는 테이블 생성 생략 헤더가 없을 경우에는 기본적으로 테이블 생성 무시 Copy python def _create_table_sql(self, table: str, filename: str, encoding=\"utf-8\", sep=',', with_header=True) -\u003e str: if with_header: column_list = self._read_csv_column_list(filename, encoding, sep) return \"CREATE TABLE IF NOT EXISTS {}({});\".format(table, column_list) else: return str() _read_csv_column_list()\n헤더와 상위 5개 행을 읽어서 데이터 타입을 추정하고, 이를 바탕으로 테이블의 열 목록을 정의 데이터 타입은 int4 또는 text 두 가지 경우만 판단하며, int4 범위에 있는 숫자형 문자 또는 NULL 값으로만 구성된 열은 int4 타입으로 지정하고, 나머지는 text 타입으로 지정 Copy python def _read_csv_column_list(self, filename: str, encoding=\"utf-8\", sep=',') -\u003e str: import csv def is_int4_type(value: str) -\u003e bool: return (not value) or (value.isdigit() and (-2147483648 \u003c= int(value) \u003c= 2147483647)) with open(filename, \"r+\", encoding=encoding) as file: reader = csv.reader(file, delimiter=sep) header = next(reader) dtypes = [all(map(is_int4_type, values)) for values in zip(*[next(reader) for _ in range(5)])] return \", \".join([\"{} {}\".format(col, (\"int4\" if is_int4 else \"text\")) for col, is_int4 in zip(header, dtypes)]) 쿼리문 실행 메서드 # copy_expert()\nPostgresHook 의 copy_expert() 메서드와 동일한데, 한글 CSV 파일은 EUC-KR 등 다른 인코딩이 필요할 수 있어 encoding 파라미터를 추가 Copy python def copy_expert(self, sql: str, filename: str, encoding=\"utf-8\") -\u003e None: from contextlib import closing self.log.info(\"Running copy expert: %s, filename: %s\", sql, filename) with open(filename, \"r+\", encoding=encoding) as file, closing(self.get_conn()) as conn, closing(conn.cursor()) as cur: cur.copy_expert(sql, file) file.truncate(file.tell()) conn.commit() Custom Hook 활용 예시 # DAG 생성 및 실행 # plugins/ 에 정의한 CustomPostgresHook 을 활용 실행 날짜에 생성된 shop.csv 파일을 보고 nshopping.search2 테이블을 생성 및 적재 shop.csv 파일을 굳이 shop_with_tab.csv 파일로 가공할 필요성을 줄여서 편의성 개선 Copy python # dags/python_with_postgres_custom.py from airflow.sdk import DAG from airflow.providers.standard.operators.python import PythonOperator from hooks.postgres import CustomPostgresHook import pendulum with DAG( dag_id=\"python_with_postgres_custom\", schedule=None, start_date=pendulum.datetime(2025, 1, 1, tz=\"Asia/Seoul\"), catchup=False, tags=[\"example\", \"hook\"], ) as dag: def bulk_load_postgres(postgres_conn_id: str, table: str, filename: str, **kwargs): custom_postgres_hook = CustomPostgresHook(postgres_conn_id=postgres_conn_id) custom_postgres_hook.bulk_load(table=table, filename=filename, if_exists=\"replace\", sep=\",\", with_header=True) bulk_load_postgres = PythonOperator( task_id=\"bulk_load_postgres\", python_callable=bulk_load_postgres, op_kwargs={\"postgres_conn_id\": \"conn-db-postgres-custom\", \"table\":\"nshopping.search2\", \"filename\":\"/opt/airflow/files/naverSearch/{{data_interval_end.in_timezone(\\\"Asia/Seoul\\\") | ds_nodash }}/shop.csv\"} ) 실행 로그 중에서 CustomPostgresHook 이 생성한 SQL문을 확인 가능 if_exists=\"replace\" 파라미터를 추가했기 때문에, 중간에 TRUNCATE TABLE 구문이 추가 따라서, 여러 번 DAG을 실행해도 매번 테이블이 초기화되어 중복된 데이터가 업로드되지 않음 Copy bash [2025-06-11, 01:24:16] INFO - DAG bundles loaded: dags-folder: source=\"airflow.dag_processing.bundles.manager.DagBundlesManager\" [2025-06-11, 01:24:16] INFO - Filling up the DagBag from /opt/airflow/dags/python_with_postgres_custom.py: source=\"airflow.models.dagbag.DagBag\" [2025-06-11, 01:24:16] INFO - Running copy expert: CREATE TABLE IF NOT EXISTS nshopping.search2(rank int4, title text, link text, image text, lprice int4, hprice int4, mallName text, productId text, productType int4, brand text, maker text, category1 text, category2 text, category3 int4, category4 int4);TRUNCATE TABLE nshopping.search2;COPY nshopping.search2 FROM STDIN DELIMITER ',' CSV HEADER;, filename: /opt/airflow/files/naverSearch/20250611/shop.csv: source=\"hooks.postgres.CustomPostgresHook\" [2025-06-11, 01:24:16] INFO - Secrets backends loaded for worker: count=1: backend_classes=[\"EnvironmentVariablesBackend\"]: source=\"supervisor\" [2025-06-11, 01:24:16] INFO - Connection Retrieved 'conn-db-postgres-custom': source=\"airflow.hooks.base\" [2025-06-11, 01:24:16] INFO - Done. Returned value was: None: source=\"airflow.task.operators.airflow.providers.standard.operators.python.PythonOperator\" 테이블 조회 # DBeaver에서 nshopping.search2 테이블이 생성되었고, 의도대로 정수형 열을 추측하여 데이터 타입을 구분해서 지정된 것을 확인 테이블 내용을 보면, 기존의 문제였던 헤더가 1행으로 들어갔던게 해결됨이 확인 또한, 추측한 데이터 타입에 맞춰서 값이 정상적으로 들어갔음을 확인 참조한 강의에서는 CSV 파일을 pd.DataFrame 객체로 읽고, SQLAlchemy의 엔진을 사용해 to_sql() 기능으로 PostgreSQL 테이블에 데이터를 적재하는 방식으로 접근 개인적으로는 PostgresHook 을 이해하고자, PostgresHook 의 원형을 최대한 유지하면서 필요한 기능만 추가하기 위해 외부 라이브러리의 사용을 제한함 ","wordCount":"2928","inLanguage":"en","image":"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/8oxi6rw0kesl9l3egs78s\/airflow-00-cover.webp?rlkey=6abx67jiweasmlwehj4o4gdle\u0026st=n484uuow\u0026dl=0","datePublished":"2025-06-08T16:52:44+09:00","dateModified":"2025-06-08T16:52:44+09:00","author":{"@type":"Person","name":"minyeamer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minyeamer.github.io/blog/airflow-study-7/"},"publisher":{"@type":"Person","name":"Minystory","logo":{"@type":"ImageObject","url":"https://minyeamer.github.io/images/favicons/favicon.ico"}}}</script><title>Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL) | Minystory</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://minyeamer.github.io/blog/airflow-study-7/><link rel=stylesheet href=/book.min.98033084bd9e5318737fe2ea3b46e2bfd9515bba654311cacafb34883e9172e0.css integrity="sha256-mAMwhL2eUxhzf+LqO0biv9lRW7plQxHKyvs0iD6RcuA=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/search-input.min.4b5ee849628964c6f19f2b9fbce66e5fcdd75b4978251fc4c2eab8ed13c4406f.js integrity="sha256-S17oSWKJZMbxnyufvOZuX83XW0l4JR/Ewuq47RPEQG8=" crossorigin=anonymous></script><link rel=preload href=/search-data.min.cb03eaa955bdbd534a561b863dc36792320fde159e17577bd3f267ea5df24f53.json as=fetch crossorigin><script>window.SEARCH_DATA_URL="/search-data.min.cb03eaa955bdbd534a561b863dc36792320fde159e17577bd3f267ea5df24f53.json"</script><script defer src=/search.min.f30f9834d4764fd9751da64098c954d01085f648ba9ca421a3c97582f8c47253.js integrity="sha256-8w+YNNR2T9l1HaZAmMlU0BCF9ki6nKQho8l1gvjEclM=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ8Z9RMBPJ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BJ8Z9RMBPJ")</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css crossorigin=anonymous><script defer src=/scroll-progress.min.841ade7e507a5f6d59c4e7bf2fe2b2ca034070677ff7957eec55610a024dd776.js integrity="sha256-hBreflB6X21ZxOe/L+KyygNAcGd/95V+7FVhCgJN13Y=" crossorigin=anonymous></script><script defer src=/dark-mode.min.e41c6440ffd9967d6f6a419ff3ce09b862009fe1646ab265f5cb2817d2a508e3.js integrity="sha256-5BxkQP/Zln1vakGf884JuGIAn+FkarJl9csoF9KlCOM=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js></script><script defer src=/copy-code.min.aaeef965f0b4992e55f976edaecb34a89d414e1791caa18c3f4f4376c6d8b5a8.js integrity="sha256-qu75ZfC0mS5V+Xbtrss0qJ1BTheRyqGMP09DdsbYtag=" crossorigin=anonymous></script><script defer src=/toc-highlightjs.093016f0ef312174ad862fdcf5792e88ab5442bd39beecc38d15643f71ab5c31.min integrity="sha256-CTAW8O8xIXSthi/c9XkuiKtUQr05vuzDjRVkP3GrXDE=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-posts book-layout-post"><div class=scroll-progress><div class=scroll-progress-bar></div></div><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><div class=sidebar-profile><div class=profile-img-wrap><a href=https://minyeamer.github.io/><img src=/images/profile/menu.jpg alt=Profile class=profile-img></a></div><div class=sidebar-social><a href=https://github.com/minyeamer target=_blank title=GitHub><i class="fa-brands fa-github"></i>
</a><a href=/categories/ title=Categories><i class="fa-solid fa-folder"></i>
</a><a href=/tags/ title=Tags><i class="fa-solid fa-tags"></i>
</a><button id=dark-mode-toggle class=dark-mode-toggle aria-label="Toggle dark mode">
<i class="fa-solid fa-circle-half-stroke"></i></button></div></div><h2 class=book-brand><a class="flex align-center" href=/><span>Minystory</span></a></h2><div class="book-search hidden"><div class=search-input-container><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/ onkeydown='event.key==="Enter"&&goToSearchPage()'>
<button type=button id=book-search-button class=book-search-btn onclick=goToSearchPage()>
<i class="fa-solid fa-magnifying-glass"></i></button></div><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden");function goToSearchPage(){const t=document.getElementById("book-search-input"),e=t.value.trim();e&&(window.location.href="/search/?q="+encodeURIComponent(e))}</script><div class=book-categories><input type=checkbox class="hidden toggle" id=categories-control checked>
<label for=categories-control class="categories-toggle categories-link"><a href=/categories/><i class="fa-solid fa-folder"></i>
<span>전체</span>
<span class=category-count>(33)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul class=categories-menu id=categories-menu><li><input type=checkbox class="hidden toggle" id=cat-algorithm>
<label for=cat-algorithm class="categories-toggle categories-link"><a href=/categories/algorithm/><i class="fa-solid fa-folder"></i>
Algorithm
<span class=category-count>(1)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/algorithm/sql/><i class="fa-solid fa-file"></i>
SQL
<span class=category-count>(1)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-cloud>
<label for=cat-cloud class="categories-toggle categories-link"><a href=/categories/cloud/><i class="fa-solid fa-folder"></i>
Cloud
<span class=category-count>(2)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/cloud/kubernetes/><i class="fa-solid fa-file"></i>
Kubernetes
<span class=category-count>(2)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-data-analysis>
<label for=cat-data-analysis class="categories-toggle categories-link"><a href=/categories/data-analysis/><i class="fa-solid fa-folder"></i>
Data Analysis
<span class=category-count>(1)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/data-analysis/dacon/><i class="fa-solid fa-file"></i>
Dacon
<span class=category-count>(1)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-data-engineering>
<label for=cat-data-engineering class="categories-toggle categories-link"><a href=/categories/data-engineering/><i class="fa-solid fa-folder"></i>
Data Engineering
<span class=category-count>(19)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/data-engineering/apache-airflow/><i class="fa-solid fa-file"></i>
Apache Airflow
<span class=category-count>(7)</span></a></li><li class=categories-link><a href=/categories/data-engineering/apache-spark/><i class="fa-solid fa-file"></i>
Apache Spark
<span class=category-count>(8)</span></a></li><li class=categories-link><a href=/categories/data-engineering/crawling/><i class="fa-solid fa-file"></i>
Crawling
<span class=category-count>(4)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-frontend>
<label for=cat-frontend class="categories-toggle categories-link"><a href=/categories/frontend/><i class="fa-solid fa-folder"></i>
Frontend
<span class=category-count>(7)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/frontend/blog/><i class="fa-solid fa-file"></i>
Blog
<span class=category-count>(7)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-linux>
<label for=cat-linux class="categories-toggle categories-link"><a href=/categories/linux/><i class="fa-solid fa-folder"></i>
Linux
<span class=category-count>(1)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/linux/ubuntu/><i class="fa-solid fa-file"></i>
Ubuntu
<span class=category-count>(1)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-project>
<label for=cat-project class="categories-toggle categories-link"><a href=/categories/project/><i class="fa-solid fa-folder"></i>
Project
<span class=category-count>(2)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/project/open-source/><i class="fa-solid fa-file"></i>
Open Source
<span class=category-count>(1)</span></a></li><li class=categories-link><a href=/categories/project/tools/><i class="fa-solid fa-file"></i>
Tools
<span class=category-count>(1)</span></a></li></ul></li></ul></div><div class=recent-posts><div class=recent-posts-header><i class="fa-solid fa-clock"></i>
<span>최신글</span></div><ul class=recent-posts-list><li class=recent-post-item><a href=/blog/hugo-blog-3/ title="Hugo 블로그 만들기 (3) - Taxonomies로 태그/카테고리 페이지 커스터마이징"><div class=recent-post-title>Hugo 블로그 만들기 (3) - Taxonomies로 태그/카테고리 페이지 커스터마이징</div><div class=recent-post-date><time datetime=2025-11-22>2025.11.22</time></div></a></li><li class=recent-post-item><a href=/blog/hugo-blog-2/ title="Hugo 블로그 만들기 (2) - 메인 레이아웃 커스터마이징 (메뉴, 목차, 헤더)"><div class=recent-post-title>Hugo 블로그 만들기 (2) - 메인 레이아웃 커스터마이징 (메뉴, 목차, 헤더)</div><div class=recent-post-date><time datetime=2025-11-04>2025.11.04</time></div></a></li><li class=recent-post-item><a href=/blog/hugo-blog-1/ title="Hugo 블로그 만들기 (1) - 프로젝트 구성과 GitHub Pages 배포 (Submodule 활용)"><div class=recent-post-title>Hugo 블로그 만들기 (1) - 프로젝트 구성과 GitHub Pages 배포 (Submodule 활용)</div><div class=recent-post-date><time datetime=2025-11-01>2025.11.01</time></div></a></li><li class=recent-post-item><a href=/blog/openup-handson/ title="[OSSCA] 2025 오픈소스 컨트리뷰션 아카데미 - PyTorch 문서 한글화 참여 후기"><div class=recent-post-title>[OSSCA] 2025 오픈소스 컨트리뷰션 아카데미 - PyTorch 문서 한글화 참여 후기</div><div class=recent-post-date><time datetime=2025-10-28>2025.10.28</time></div></a></li><li class=recent-post-item><a href=/blog/uv-project/ title="[Python] uv로 프로젝트 구성하고 PyPI 배포하기 - Rust 기반 고속 패키지 관리"><div class=recent-post-title>[Python] uv로 프로젝트 구성하고 PyPI 배포하기 - Rust 기반 고속 패키지 관리</div><div class=recent-post-date><time datetime=2025-07-23>2025.07.23</time></div></a></li></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><i class="fa-solid fa-bars book-icon" id=menu-icon></i></label><h3><a href=https://minyeamer.github.io/ class=site-title>Minystory</a></h3><label for=toc-control><i class="fa-solid fa-list book-icon" id=toc-icon></i></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#docker-compose-이해>Docker Compose 이해</a></li><li><a href=#postgres-컨테이너-생성>Postgres 컨테이너 생성</a><ul><li><a href=#docker-compose>Docker Compose</a></li><li><a href=#dbeaver-접속>DBeaver 접속</a></li><li><a href=#postgres-테이블-생성>Postgres 테이블 생성</a></li><li><a href=#pythonoperator>PythonOperator</a></li></ul></li><li><a href=#connection--hook>Connection & Hook</a><ul><li><a href=#postgres-provider-문서-보기>Postgres Provider 문서 보기</a></li><li><a href=#connection-추가>Connection 추가</a></li><li><a href=#postgreshook>PostgresHook</a></li></ul></li><li><a href=#bulk_load>bulk_load</a><ul><li><a href=#postgres-provider-문서-보기-1>Postgres Provider 문서 보기</a></li><li><a href=#postgres-테이블-생성-1>Postgres 테이블 생성</a></li><li><a href=#csv-파일-가공>CSV 파일 가공</a></li><li><a href=#bulk_load-활용-예시>bulk_load 활용 예시</a></li></ul></li><li><a href=#custom-hook>Custom Hook</a><ul><li><a href=#basehook>BaseHook</a></li><li><a href=#postgreshook-개선점-파악>PostgresHook 개선점 파악</a></li></ul></li><li><a href=#custompostgreshook>CustomPostgresHook</a><ul><li><a href=#postgresql-연결-메서드>PostgreSQL 연결 메서드</a></li><li><a href=#쿼리문-생성-메서드>쿼리문 생성 메서드</a></li><li><a href=#쿼리문-실행-메서드>쿼리문 실행 메서드</a></li></ul></li><li><a href=#custom-hook-활용-예시>Custom Hook 활용 예시</a><ul><li><a href=#dag-생성-및-실행>DAG 생성 및 실행</a></li><li><a href=#테이블-조회>테이블 조회</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><header class=post-header><div class=post-header-category><a href=/categories/data-engineering/apache-airflow/ class=post-header-category-link>Data Engineering/Apache Airflow</a></div><h1 class=post-header-title>Apache Airflow - 외부 시스템 연동 (Connection, Hook, PostgreSQL)</h1><div class=post-header-date><time datetime=2025-06-08T16:52:44+09:00>2025. 6. 8. 16:52</time></div></header><div class=book-cover><img src="https://dl.dropboxusercontent.com/scl/fi/8oxi6rw0kesl9l3egs78s/airflow-00-cover.webp?rlkey=6abx67jiweasmlwehj4o4gdle&amp;st=n484uuow&amp;dl=0" alt="Cover Image" class=book-cover-img></div><h2 id=docker-compose-이해>Docker Compose 이해
<a class=anchor href=#docker-compose-%ec%9d%b4%ed%95%b4>#</a></h2><ul><li>목적 : 1개 이상의 도커 컨테이너 생성 시 컨테이너들의 설정을 관리할 수 있도록 해주는 기능</li><li>방법 : <code>docker-compose.yaml</code> 파일에 컨테이너들의 설정을 입력</li><li>사용 : <code>.yaml</code> 파일이 있는 위치에서 <code>docker compose up</code> 명령어를 입력하여 실행</li><li>yaml 파일은 들여쓰기 문법을 사용하며 Airflow의 Docker Compose는 아래와 같이 구분</li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>x-airflow-common</span><span class=p>:</span><span class=w> </span><span class=c># 각 서비스에 공통 적용될 항목들</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=c># 컨테이너로 실행할 서비스를 정의</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumns</span><span class=p>:</span><span class=w> </span><span class=c># 컨테이너에 연결할 볼륨을 정의</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w> </span><span class=c># 컨테이너에 연결할 네트워크를 정의</span></span></span></code></pre></div></div><p><code>x-airflow-common</code></p><ul><li>공통으로 사용할 항목을 <code>&</code> 를 붙여서 지정</li><li><code>&</code> 아래의 모든 영역은 공통 항목으로 묶여 한번에 가져올 수 있음</li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>x-airflow-common</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;airflow-common</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>${AIRFLOW_IMAGE_NAME:-apache/airflow:3.0.1}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>&amp;airflow-common-env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>AIRFLOW__CORE__EXECUTOR</span><span class=p>:</span><span class=w> </span><span class=l>CeleryExecutor</span></span></span></code></pre></div></div><p><code>services</code></p><ul><li>컨테이너로 올릴 서비스 목록을 지정</li><li>공통 항목을 <code>&lt;&lt;: *airflow-common</code> 과 같은 형식으로 불러오기</li><li>환경 변수가 있을 경우 <code>environment</code> 아래에 입력</li><li><code>ports</code> 는 호스트에서 컨테이너에 접속하기 위해 맵핑할 포트를 명시<ul><li><code>expose</code> 는 <code>ports</code> 와 다르게 내부 컨테이너 간에 연결할 때 사용할 포트를 명시</li></ul></li><li><code>depends_on</code> 은 컨테이너의 실행 순서를 정의<ul><li><code>airflow-apiserver</code> 는 <code>airflow-init</code> 에 대한 종속적 관계</li></ul></li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>airflow-apiserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*airflow-common</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>api-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8080:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;curl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--fail&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;http://localhost:8080/api/v2/version&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span><span class=cp>*airflow-common-depends-on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>airflow-init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>service_completed_successfully</span></span></span></code></pre></div></div><p><code>volumes</code></p><ul><li>컨테이너 내 데이터를 유지하기 위해 외부와 연결하기 위한 볼륨 정보</li><li>볼륨 리스트를 보려면 <code>docker volume ls</code> 명령어 사용</li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>postgres-db-volume:</span></span></span></code></pre></div></div><ul><li>서비스를 정의할 때 생성한 볼륨과 컨테이너의 내부 경로를 연결 가능</li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres-db-volume:/var/lib/postgresql/data</span></span></span></code></pre></div></div><p><code>networks</code></p><ul><li>컨테이너를 격리된 네트워크로 그룹화하기 위한 네트워크 정보</li><li>컨테이너는 유동 IP를 가지게 되어 재가동할 때마다 IP 주소가 변경될 수 있는데, 고정 IP를 할당하기 위해 networks 활용 가능</li><li>네트워크 리스트를 보려면 <code>docker network ls</code> 명령어 사용</li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>network_custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>bridge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ipam</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>subnet</span><span class=p>:</span><span class=w> </span><span class=m>172.28.0.0</span><span class=l>/16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>gateway</span><span class=p>:</span><span class=w> </span><span class=m>172.28.0.1</span></span></span></code></pre></div></div><ul><li>Airflow에서 기본적으로 사용하는 <code>airflow_default</code> 네트워크 대역이 <code>172.18.0.0/16</code> 서브넷 범위인데,
아래에서 새 컨테이너를 만들기 위해 겹치지 않는 대역의 <code>network_custom</code> 을 정의</li></ul><div class=book-codeblock data-lang=bash><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">bash</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% docker network inspect <span class=o>{</span>network_id<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Name&#34;</span>: <span class=s2>&#34;airflow_default&#34;</span>,
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>        <span class=s2>&#34;IPAM&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Driver&#34;</span>: <span class=s2>&#34;default&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Options&#34;</span>: null,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Config&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Subnet&#34;</span>: <span class=s2>&#34;172.18.0.0/16&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Gateway&#34;</span>: <span class=s2>&#34;172.18.0.1&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span></span></span></code></pre></div></div><h2 id=postgres-컨테이너-생성>Postgres 컨테이너 생성
<a class=anchor href=#postgres-%ec%bb%a8%ed%85%8c%ec%9d%b4%eb%84%88-%ec%83%9d%ec%84%b1>#</a></h2><h3 id=docker-compose>Docker Compose
<a class=anchor href=#docker-compose>#</a></h3><ul><li>Airflow에서 기본으로 사용하는 Postgres 컨테이너 외에 새로운 Postgres 컨테이너 하나를 추가로 생성</li><li>DB 사용자에 대한 정보는 환경 변수 <code>environment</code> 로 입력</li><li>5432 포트로 접속할 수 있게 포트 맵핑 적용<ul><li>기존의 <code>postgres</code> 컨테이너도 5431 포트로 접속할 수 있게 마찬가지로 포트 맵핑 적용</li></ul></li><li><code>postgres-custom-db-volume</code> 볼륨을 추가하고 컨테이너 내부 경로와 연결</li><li>위에서 정의한 <code>network_custom</code> 네트워크에 연결하면서 IP 주소는 <code>172.28.0.3</code> 으로 고정<ul><li>다른 컨테이너에도 <code>network_custom</code> 및 겹치지 않는 고정 IP 주소를 할당</li></ul></li></ul><div class=book-codeblock data-lang=yaml><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">yaml</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres_custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>minyeamer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>minyeamer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>minyeamer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>TZ</span><span class=p>:</span><span class=w> </span><span class=l>Asia/Seoul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres-custom-db-volume:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5432</span><span class=p>:</span><span class=m>5432</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>network_custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ipv4_address</span><span class=p>:</span><span class=w> </span><span class=m>172.28.0.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>5431</span><span class=p>:</span><span class=m>5432</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>network_custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ipv4_address</span><span class=p>:</span><span class=w> </span><span class=m>172.28.0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres-db-volume</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres-custom-db-volume</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>network_custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span></span></span></code></pre></div></div><ul><li>실행 후 컨테이너 목록을 조회하면 <code>airflow-postgres_custom-1</code> 명칭의 컨테이너가 같이 올라온 것을 확인</li></ul><div class=book-codeblock data-lang=bash><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">bash</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% docker ps
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS                    PORTS                    NAMES
</span></span><span class=line><span class=cl>72541e89bff4   apache/airflow:3.0.1   <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>57</span> seconds ago   Up <span class=m>20</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp                 airflow-airflow-worker-1
</span></span><span class=line><span class=cl>1735bc475bff   apache/airflow:3.0.1   <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>57</span> seconds ago   Up <span class=m>36</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   0.0.0.0:8080-&gt;8080/tcp   airflow-airflow-apiserver-1
</span></span><span class=line><span class=cl>d2b680f273e3   apache/airflow:3.0.1   <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>57</span> seconds ago   Up <span class=m>36</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp                 airflow-airflow-scheduler-1
</span></span><span class=line><span class=cl>f23c6d30d22c   apache/airflow:3.0.1   <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>57</span> seconds ago   Up <span class=m>36</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp                 airflow-airflow-dag-processor-1
</span></span><span class=line><span class=cl>09992f09ac5e   apache/airflow:3.0.1   <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>57</span> seconds ago   Up <span class=m>36</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp                 airflow-airflow-triggerer-1
</span></span><span class=line><span class=cl>5c1b13f33229   postgres:13            <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>58</span> seconds ago   Up <span class=m>56</span> seconds             0.0.0.0:5432-&gt;5432/tcp   airflow-postgres_custom-1
</span></span><span class=line><span class=cl>e23d4eb919fc   postgres:13            <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>58</span> seconds ago   Up <span class=m>56</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   0.0.0.0:5431-&gt;5432/tcp   airflow-postgres-1
</span></span><span class=line><span class=cl>86fc82a16953   redis:7.2-bookworm     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>58</span> seconds ago   Up <span class=m>56</span> seconds <span class=o>(</span>healthy<span class=o>)</span>   6379/tcp                 airflow-redis-1</span></span></code></pre></div></div><h3 id=dbeaver-접속>DBeaver 접속
<a class=anchor href=#dbeaver-%ec%a0%91%ec%86%8d>#</a></h3><ul><li><a href=https://dbeaver.io/download/ target=_blank rel="noopener noreferrer">Beaver Community 버전</a>을 다운로드 및 설치한 후 실행</li><li>좌측 상단의 <code>New Database Connection</code> 을 클릭해 PostgreSQL 연결을 생성<ul><li>Port는 Docker Compose에서 맵핑한 5432 사용</li><li>Database, Username, Password 또한 Docker Compose에서 지정한 값을 사용</li></ul></li></ul><div style=text-align:center;display:flex;gap:.5rem;align-items:flex-start;flex-wrap:nowrap><div style="flex:0 0 50%;max-width:50%"><img src="https://dl.dropboxusercontent.com/scl/fi/mdmcowq7snd9kre1nk3er/airflow-47-dbeaver-select-database.webp?rlkey=mqhmcjbk9ffa0cjqb4yib3wkw&amp;dl=0" alt="Connect to a database > Select your database" style=width:100%;height:auto;display:block></div><div style="flex:0 0 50%;max-width:50%"><img src="https://dl.dropboxusercontent.com/scl/fi/fjrzi28evemhofio626rl/airflow-48-dbeaver-connection-settings.webp?rlkey=q4xqe24sguok0arrnn3z8jv2b&amp;dl=0" alt="Connect to a database > Connection Settings" style=width:100%;height:auto;display:block></div></div><ul><li>정상적으로 연결되었다면 아래와 같이 Database 명칭을 확인 가능</li></ul><div style=text-align:center><img src="https://dl.dropboxusercontent.com/scl/fi/76s6qjohro7qeawziu92c/airflow-49-dbeaver-database-navigator.webp?rlkey=b8ja2rvtsyqjmn6tay2mw8hl4&amp;dl=0" alt="Database Navigator" style=width:100%;max-width:518px></div><h3 id=postgres-테이블-생성>Postgres 테이블 생성
<a class=anchor href=#postgres-%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%83%9d%ec%84%b1>#</a></h3><ul><li><code>PythonOperator</code> 를 사용해 새로 생성한 PostgreSQL 컨테이너에 임의의 값을 INSERT 하는 작업을 구현하기 전에,
아래와 같이 <code>public.dag_run</code> 테이블을 생성</li></ul><div class=book-codeblock data-lang=sql><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">sql</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>public</span><span class=p>.</span><span class=n>dag_run</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>dag_id</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>task_id</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>run_id</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>msg</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div></div><ul><li>테이블이 정상적으로 만들어졌다면 새로고침 후 아래와 같이 테이블 내 컬럼 내역을 확인 가능</li></ul><p><img src="https://dl.dropboxusercontent.com/scl/fi/7cj3j0xkqa33yk11x4fdq/airflow-50-dbeaver-dagrun-columns.webp?rlkey=vo7evh64owh5o5weotwny3nt9&amp;dl=0" alt="dag_run > Properties > Columns > [dag_id, task_id, run_id, msg]"></p><h3 id=pythonoperator>PythonOperator
<a class=anchor href=#pythonoperator>#</a></h3><ul><li>PostgreSQL에 연결해 현재 실행 정보를 <code>INSERT INTO</code> 로 추가하는 함수 <code>insert_into_postgres()</code> 를 실행<ul><li>DB 연결 시 <code>conn</code> 세션 객체 생성 후 <code>.close()</code> 로 종료하는 구문을 <code>closing</code> 으로 대체</li><li>DB 세션에서 쿼리를 실행하는 <code>cursor</code> 객체를 만들고 해당 객체를 통해 SQL문을 수행</li><li>함수에 인수로 전달하는 DB 연결 정보는 마찬가지로 Docker Compose에서 지정한 값을 사용</li></ul></li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># dags/python_with_postgres.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.sdk</span> <span class=kn>import</span> <span class=n>DAG</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.providers.standard.operators.python</span> <span class=kn>import</span> <span class=n>PythonOperator</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pendulum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>DAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dag_id</span><span class=o>=</span><span class=s2>&#34;python_with_postgres&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>schedule</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=o>=</span><span class=n>pendulum</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=s2>&#34;Asia/Seoul&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>catchup</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;example&#34;</span><span class=p>,</span> <span class=s2>&#34;hook&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>as</span> <span class=n>dag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>insert_into_postgres</span><span class=p>(</span><span class=n>ip</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>port</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>dbname</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>passwd</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>closing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>closing</span><span class=p>(</span><span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>ip</span><span class=p>,</span> <span class=n>dbname</span><span class=o>=</span><span class=n>dbname</span><span class=p>,</span> <span class=n>user</span><span class=o>=</span><span class=n>user</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>passwd</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)))</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>closing</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>())</span> <span class=k>as</span> <span class=n>cursor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>dag_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>dag_id</span>
</span></span><span class=line><span class=cl>                <span class=n>task_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>task_id</span>
</span></span><span class=line><span class=cl>                <span class=n>run_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>run_id</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>=</span> <span class=s2>&#34;INSERT INTO 수행&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=s2>&#34;INSERT INTO dag_run VALUES (</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>);&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>,(</span><span class=n>dag_id</span><span class=p>,</span><span class=n>task_id</span><span class=p>,</span><span class=n>run_id</span><span class=p>,</span><span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>postgres_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>task_id</span><span class=o>=</span><span class=s2>&#34;postgres_task&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>python_callable</span><span class=o>=</span><span class=n>insert_into_postgres</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>op_args</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;172.28.0.3&#34;</span><span class=p>,</span> <span class=s2>&#34;5432&#34;</span><span class=p>,</span> <span class=s2>&#34;minyeamer&#34;</span><span class=p>,</span> <span class=s2>&#34;minyeamer&#34;</span><span class=p>,</span> <span class=s2>&#34;minyeamer&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div></div><ul><li>DAG을 실행한 후 DBeaver에서 <code>dag_run</code> 테이블 조회 시 아래와 같이 하나의 행이 올라온 것을 확인</li></ul><div style=text-align:center><img src="https://dl.dropboxusercontent.com/scl/fi/qkhf61bfelnqo014ics1d/airflow-51-dbeaver-dagrun-row.webp?rlkey=nnj98cyd7dn4feedrdoyztee4&amp;dl=0" alt="dag_run > Data > manual__2025-06-08T04:11:08.876393+00:00" style=width:100%;max-width:691px></div><h4 id=문제점-및-해결방법>문제점 및 해결방법
<a class=anchor href=#%eb%ac%b8%ec%a0%9c%ec%a0%90-%eb%b0%8f-%ed%95%b4%ea%b2%b0%eb%b0%a9%eb%b2%95>#</a></h4><ul><li>문제점 : DB 접속정보가 노출되고 접속정보가 변경되면 대응하기가 어려움</li><li>해결방법<ol><li>Variable 이용</li><li>Hook 이용</li></ol></li></ul><h2 id=connection--hook>Connection & Hook
<a class=anchor href=#connection--hook>#</a></h2><ul><li>Connection : Airflow에서 외부와 연동하기 위해 설정하는 기본 정보</li><li>Hook<ul><li>Airflow에서 외부 솔루션의 기능을 사용할 수 있도록 미리 구현된 메서드를 가진 클래스</li><li>Connection 정보를 통해 생성되는 객체로, 접속정보가 코드상 노출되지 않음</li><li>외부의 특정 솔루션을 다룰 수 있는 메서드가 구현되어 있음</li><li>Operator와 같이 Task를 만들어내지는 못하기 때문에 Operator 내 함수에서 사용</li></ul></li></ul><h3 id=postgres-provider-문서-보기>Postgres Provider 문서 보기
<a class=anchor href=#postgres-provider-%eb%ac%b8%ec%84%9c-%eb%b3%b4%ea%b8%b0>#</a></h3><a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/index.html target=_blank class=bookmark-card><div class=bookmark-image><img src="https://dl.dropboxusercontent.com/scl/fi/jaltieh1sb4r7ozm6ju3e/airflow-00-cover-bg.webp?rlkey=s10wwm9o11zy79dwm1vje30sb&amp;dl=0" alt="apache-airflow-providers-postgres — apache-airflow-providers-postgres Documentation"></div><div class=bookmark-content><h3 class=bookmark-title>apache-airflow-providers-postgres — apache-airflow-providers-postgres …</h3><small class=bookmark-url>airflow.apache.org</small></div></a><ul><li>Providers에 속한 Postgres 문서에서
<a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.get_conn target=_blank rel="noopener noreferrer">Connection 접속 과정</a>을 조회 가능</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_conn</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Establish a connection to a postgres database.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># check for authentication via AWS IAM</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>conn</span><span class=o>.</span><span class=n>extra_dejson</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;iam&#34;</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>login</span><span class=p>,</span> <span class=n>conn</span><span class=o>.</span><span class=n>password</span><span class=p>,</span> <span class=n>conn</span><span class=o>.</span><span class=n>port</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_iam_token</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>conn_args</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>login</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dbname&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>database</span> <span class=ow>or</span> <span class=n>conn</span><span class=o>.</span><span class=n>schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>raw_cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>extra_dejson</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;cursor&#34;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>raw_cursor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn_args</span><span class=p>[</span><span class=s2>&#34;cursor_factory&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cursor</span><span class=p>(</span><span class=n>raw_cursor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>options</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn_args</span><span class=p>[</span><span class=s2>&#34;options&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>options</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>arg_name</span><span class=p>,</span> <span class=n>arg_val</span> <span class=ow>in</span> <span class=n>conn</span><span class=o>.</span><span class=n>extra_dejson</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>arg_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignored_extra_options</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn_args</span><span class=p>[</span><span class=n>arg_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>arg_val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>conn_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>conn</span></span></span></code></pre></div></div><ul><li>Connection으로부터 <code>host</code>, <code>login</code>, <code>password</code>, <code>database</code>, <code>port</code>
정보를 읽어서 DB 연결에 대한 파라미터로 활용하는 것을 확인</li><li>마지막 줄에는 <code>psycopg2.connect()</code> 연결에 대한 <code>psycopg2.extensions.connection</code> 세션 객체를 반환</li></ul><h3 id=connection-추가>Connection 추가
<a class=anchor href=#connection-%ec%b6%94%ea%b0%80>#</a></h3><ul><li>postgres 타입의 Connection을 새로 생성</li><li>연결 정보로 Docker Compose에서 지정한 값을 입력</li><li>Connection에 입력한 각 항목은 앞서 확인한 <code>get_conn()</code> 메서드에서 PostgreSQL 연결 시 사용</li></ul><div style=text-align:center><img src="https://dl.dropboxusercontent.com/scl/fi/3q28bhxv5ld52bx3dqaiz/airflow-52-postgres-connection.webp?rlkey=py1x2x3gab8qemhlyw38h188k&amp;dl=0" alt="Add Connection - Postgres" style=width:100%;max-width:691px></div><h3 id=postgreshook>PostgresHook
<a class=anchor href=#postgreshook>#</a></h3><ul><li>Provider 패키지를 설치하고, 기존에 <code>psycopg2</code> 라이브러리로 직접 PostgreSQL에 연결하던 부분을 <code>PostgresHook</code> 으로 변경</li></ul><div class=book-codeblock data-lang=bash><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">bash</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install apache-airflow-providers-postgres</span></span></code></pre></div></div><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># dags/python_with_postgres_hook.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.sdk</span> <span class=kn>import</span> <span class=n>DAG</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.providers.standard.operators.python</span> <span class=kn>import</span> <span class=n>PythonOperator</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pendulum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>DAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dag_id</span><span class=o>=</span><span class=s2>&#34;python_with_postgres_hook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>schedule</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=o>=</span><span class=n>pendulum</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=s2>&#34;Asia/Seoul&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>catchup</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;example&#34;</span><span class=p>,</span> <span class=s2>&#34;hook&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>as</span> <span class=n>dag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>insert_into_postgres</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>airflow.providers.postgres.hooks.postgres</span> <span class=kn>import</span> <span class=n>PostgresHook</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>closing</span>
</span></span><span class=line><span class=cl>        <span class=n>postgres_hook</span> <span class=o>=</span> <span class=n>PostgresHook</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>closing</span><span class=p>(</span><span class=n>postgres_hook</span><span class=o>.</span><span class=n>get_conn</span><span class=p>())</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>closing</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>())</span> <span class=k>as</span> <span class=n>cursor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>dag_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>dag_id</span>
</span></span><span class=line><span class=cl>                <span class=n>task_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>task_id</span>
</span></span><span class=line><span class=cl>                <span class=n>run_id</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;ti&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>run_id</span>
</span></span><span class=line><span class=cl>                <span class=n>msg</span> <span class=o>=</span> <span class=s2>&#34;INSERT INTO 수행&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>sql</span> <span class=o>=</span> <span class=s2>&#34;INSERT INTO dag_run VALUES (</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>,</span><span class=si>%s</span><span class=s2>);&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>,(</span><span class=n>dag_id</span><span class=p>,</span><span class=n>task_id</span><span class=p>,</span><span class=n>run_id</span><span class=p>,</span><span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>postgres_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>task_id</span><span class=o>=</span><span class=s2>&#34;postgres_task&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>python_callable</span><span class=o>=</span><span class=n>insert_into_postgres</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>op_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;postgres_conn_id&#34;</span><span class=p>:</span><span class=s2>&#34;conn-db-postgres-custom&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div></div><ul><li>DAG을 실행한 후 DBeaver에서 <code>dag_run</code> 테이블 조회 시 아래와 같이 두 번째 행이 추가된 것을 확인</li></ul><div style=text-align:center><img src="https://dl.dropboxusercontent.com/scl/fi/qgawsskyvb52i0d82sjbs/airflow-53-dbeaver-dagrun-rows.webp?rlkey=l81q9dh7a68q062s0nrnam77v&amp;dl=0" alt="dag_run > Data > manual__2025-06-08T06:15:41.672840+00:00" style=width:100%;max-width:691px></div><h2 id=bulk_load>bulk_load
<a class=anchor href=#bulk_load>#</a></h2><h3 id=postgres-provider-문서-보기-1>Postgres Provider 문서 보기
<a class=anchor href=#postgres-provider-%eb%ac%b8%ec%84%9c-%eb%b3%b4%ea%b8%b0-1>#</a></h3><a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.bulk_load target=_blank class=bookmark-card><div class=bookmark-image><img src="https://dl.dropboxusercontent.com/scl/fi/jaltieh1sb4r7ozm6ju3e/airflow-00-cover-bg.webp?rlkey=s10wwm9o11zy79dwm1vje30sb&amp;dl=0" alt="airflow.providers.postgres.hooks.postgres — apache-airflow-providers-postgres Documentation"></div><div class=bookmark-content><h3 class=bookmark-title>airflow.providers.postgres.hooks.postgres — apache-airflow-providers-postgres …</h3><small class=bookmark-url>airflow.apache.org</small></div></a><ul><li>PostgreSQL에 데이터를 업로드하는 <code>bulk_load()</code> 메서드에 대해 살펴보기</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>bulk_load</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>tmp_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Load a tab-delimited file into a database table.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;COPY </span><span class=si>{</span><span class=n>table</span><span class=si>}</span><span class=s2> FROM STDIN&#34;</span><span class=p>,</span> <span class=n>tmp_file</span><span class=p>)</span></span></span></code></pre></div></div><ul><li><code>bulk_load()</code> 메서드는 내부적으로 <code>copy_expert()</code> 메서드를 사용하는데,
<a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.copy_expert target=_blank rel="noopener noreferrer">해당 소스코드</a>를 조회</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>copy_expert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Running copy expert: </span><span class=si>%s</span><span class=s2>, filename: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_conn</span><span class=p>())</span> <span class=k>as</span> <span class=n>conn</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>())</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file</span><span class=o>.</span><span class=n>truncate</span><span class=p>(</span><span class=n>file</span><span class=o>.</span><span class=n>tell</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span></span></code></pre></div></div><ul><li><p><code>copy_expert()</code> 메서드는 <code>get_conn()</code> 메서드를 통해 세션 객체를 얻어오고,
세션 객체로부터 <code>cursor</code> 객체를 만들어서 해당 객체가 가지고 있는 <code>copy_expert()</code> 메서드를 수행</p></li><li><p><a href=https://www.psycopg.org/docs/cursor.html#cursor.copy_expert target=_blank rel="noopener noreferrer">Psycopg 공식 문서</a>에 따르면,
<code>copy_expert()</code> 메서드는 <code>file</code> 객체를 전달받아서 <code>COPY TO</code> 문법에 대응되는 SQL문을 실행해 테이블에 업로드 수행</p></li></ul><blockquote class=book-hint><p>The <em>sql</em> statement should be in the form <em>COPY table TO STDOUT</em> to
export <em>table</em> to the file object passed as argument or <em>COPY table FROM STDIN</em> to
import the content of the file object into <em>table</em>.</p></blockquote><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=mi>8192</span><span class=p>)</span></span></span></code></pre></div></div><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>cur</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=s2>&#34;COPY test TO STDOUT WITH CSV HEADER&#34;</span><span class=p>,</span> <span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>id</span><span class=p>,</span><span class=n>num</span><span class=p>,</span><span class=n>data</span>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=n>abc</span><span class=s1>&#39;def</span>
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=p>,,</span><span class=n>dada</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></div></div><h3 id=postgres-테이블-생성-1>Postgres 테이블 생성
<a class=anchor href=#postgres-%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%83%9d%ec%84%b1-1>#</a></h3><ul><li>저번에 만든 Custom Operator로 가져온 네이버 쇼핑 검색 결과 <a href=/blog/airflow-study-6/#csv-%ed%8c%8c%ec%9d%bc-%ed%99%95%ec%9d%b8>shop.csv</a>
파일을 PostgreSQL에 업로드할 계획을 가지고 테이블 구조를 정의</li><li>CSV 파일과 동일한 열을 <code>TEXT</code> 타입으로 가지는 <code>nshopping.search</code> 테이블을 생성</li></ul><div class=book-codeblock data-lang=sql><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">sql</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>nshopping_search</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rank</span><span class=w>        </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>title</span><span class=w>       </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>link</span><span class=w>        </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=w>       </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>lprice</span><span class=w>      </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hprice</span><span class=w>      </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mallName</span><span class=w>    </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>productId</span><span class=w>   </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>productType</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>brand</span><span class=w>       </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>maker</span><span class=w>       </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>category1</span><span class=w>   </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>category2</span><span class=w>   </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>category3</span><span class=w>   </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>category4</span><span class=w>   </span><span class=nb>text</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div></div><ul><li>DBeaver에서 <code>nshopping</code> 스키마를 만들고 SQL문을 수행하면 아래와 같이 테이블 열 목록을 확인 가능</li></ul><p><img src="https://dl.dropboxusercontent.com/scl/fi/fzg4ruvxagiz3vfa5z13e/airflow-54-dbeaver-search-columns.webp?rlkey=o3ovhjjfr7xyktexyjux56el2&amp;dl=0" alt="search > Properties > Columns"></p><h3 id=csv-파일-가공>CSV 파일 가공
<a class=anchor href=#csv-%ed%8c%8c%ec%9d%bc-%ea%b0%80%ea%b3%b5>#</a></h3><blockquote class=book-hint><p>Load a tab-delimited file into a database table.</p></blockquote><ul><li>앞서 <code>bulk_load()</code> 메서드의 주석에 <code>Tab</code> 으로 구분된 파일을 업로드한다고 명시되어 있기 때문에, <code>shop.csv</code> 파일을 <code>,</code> 대신 <code>Tab</code> 으로 구분한 <code>shop_with_tab.csv</code> 파일을 같은 위치에 생성<ul><li>vi 편집기로 파일을 열었다면 <code>%s/,/\t/g</code> 명령어를 입력해 <code>,</code> 를 <code>Tab</code> 으로 변경 가능</li></ul></li></ul><div class=data-container><table class=data-table><thead><tr><th title=rank>rank</th><th title=title>title</th><th title=link>link</th><th title=image>image</th><th title=lprice>lprice</th><th title=hprice>hprice</th><th title=mallName>mallName</th><th title=productId>productId</th><th title=productType>productType</th><th title=brand>brand</th><th title=maker>maker</th><th title=category1>category1</th><th title=category2>category2</th><th title=category3>category3</th><th title=category4>category4</th></tr></thead><tbody><tr><td title=1>1</td><td title="삼성 갤럭시북 인강용 사무용 업무용 가성비 윈도우11 저가 싼 태블릿 <b>노트북</b> 추천 기본팩">삼성 갤럭시북 인강용 사무용 업무용 가성비 윈도우11 저가 싼 태블릿 <b>노트북</b> 추천 기본팩</td><td title=https://smartstore.naver.com/main/products/10407884292><a href=https://smartstore.naver.com/main/products/10407884292 target=_blank rel="noopener noreferrer">https://smartstore.naver.com/main/products/10407884292</a></td><td title=https://shopping-phinf.pstatic.net/main_8795238/87952389253.11.jpg><a href=https://shopping-phinf.pstatic.net/main_8795238/87952389253.11.jpg target=_blank rel="noopener noreferrer">https://shopping-phinf.pstatic.net/main_8795238/87952389253.11.jpg</a></td><td title=428000>428000</td><td title></td><td title="삼성공식파트너 코인비엠에스">삼성공식파트너 코인비엠에스</td><td title=87952389253>87952389253</td><td title=2>2</td><td title=갤럭시북>갤럭시북</td><td title=삼성전자>삼성전자</td><td title=디지털/가전>디지털/가전</td><td title=노트북>노트북</td><td title></td><td title></td></tr><tr><td title=2>2</td><td title="LG전자 울트라PC 라이젠5 사무용 인강용 저렴한 8GB NVMe256GB LG<b>노트북</b>">LG전자 울트라PC 라이젠5 사무용 인강용 저렴한 8GB NVMe256GB LG<b>노트북</b></td><td title=https://smartstore.naver.com/main/products/6174236911><a href=https://smartstore.naver.com/main/products/6174236911 target=_blank rel="noopener noreferrer">https://smartstore.naver.com/main/products/6174236911</a></td><td title=https://shopping-phinf.pstatic.net/main_8371873/83718736488.14.jpg><a href=https://shopping-phinf.pstatic.net/main_8371873/83718736488.14.jpg target=_blank rel="noopener noreferrer">https://shopping-phinf.pstatic.net/main_8371873/83718736488.14.jpg</a></td><td title=599000>599000</td><td title></td><td title="제이 씨앤에스">제이 씨앤에스</td><td title=83718736488>83718736488</td><td title=2>2</td><td title=LG전자>LG전자</td><td title=LG전자>LG전자</td><td title=디지털/가전>디지털/가전</td><td title=노트북>노트북</td><td title></td><td title></td></tr><tr><td title=3>3</td><td title="LG그램 <b>노트북</b> 14그램 Ultra5 16GB 256GB 인텔Arc GPU 인강용">LG그램 <b>노트북</b> 14그램 Ultra5 16GB 256GB 인텔Arc GPU 인강용</td><td title=https://smartstore.naver.com/main/products/9091504708><a href=https://smartstore.naver.com/main/products/9091504708 target=_blank rel="noopener noreferrer">https://smartstore.naver.com/main/products/9091504708</a></td><td title=https://shopping-phinf.pstatic.net/main_8663600/86636005031.7.jpg><a href=https://shopping-phinf.pstatic.net/main_8663600/86636005031.7.jpg target=_blank rel="noopener noreferrer">https://shopping-phinf.pstatic.net/main_8663600/86636005031.7.jpg</a></td><td title=1149000>1149000</td><td title></td><td title=온라인총판대리점>온라인총판대리점</td><td title=86636005031>86636005031</td><td title=2>2</td><td title=LG그램>LG그램</td><td title=LG전자>LG전자</td><td title=디지털/가전>디지털/가전</td><td title=노트북>노트북</td><td title></td><td title></td></tr><tr><td title=4>4</td><td title="삼성전자 갤럭시북4 NT750XGR-A51A 16GB 256GB">삼성전자 갤럭시북4 NT750XGR-A51A 16GB 256GB</td><td title=https://search.shopping.naver.com/catalog/52631236642><a href=https://search.shopping.naver.com/catalog/52631236642 target=_blank rel="noopener noreferrer">https://search.shopping.naver.com/catalog/52631236642</a></td><td title=https://shopping-phinf.pstatic.net/main_5263123/52631236642.20250124094900.jpg><a href=https://shopping-phinf.pstatic.net/main_5263123/52631236642.20250124094900.jpg target=_blank rel="noopener noreferrer">https://shopping-phinf.pstatic.net/main_5263123/52631236642.20250124094900.jpg</a></td><td title=799000>799000</td><td title></td><td title=네이버>네이버</td><td title=52631236642>52631236642</td><td title=1>1</td><td title=갤럭시북4>갤럭시북4</td><td title=삼성전자>삼성전자</td><td title=디지털/가전>디지털/가전</td><td title=노트북>노트북</td><td title></td><td title></td></tr><tr><td title=5>5</td><td title="2025 LG그램 15 Ai 라이젠5 16GB 256GB AMD 포토샵 대학생 인강용 <b>노트북</b>">2025 LG그램 15 Ai 라이젠5 16GB 256GB AMD 포토샵 대학생 인강용 <b>노트북</b></td><td title=https://smartstore.naver.com/main/products/10133562287><a href=https://smartstore.naver.com/main/products/10133562287 target=_blank rel="noopener noreferrer">https://smartstore.naver.com/main/products/10133562287</a></td><td title=https://shopping-phinf.pstatic.net/main_8767806/87678065467.4.jpg><a href=https://shopping-phinf.pstatic.net/main_8767806/87678065467.4.jpg target=_blank rel="noopener noreferrer">https://shopping-phinf.pstatic.net/main_8767806/87678065467.4.jpg</a></td><td title=1239000>1239000</td><td title></td><td title=창이로운>창이로운</td><td title=87678065467>87678065467</td><td title=2>2</td><td title=LG그램>LG그램</td><td title=LG전자>LG전자</td><td title=디지털/가전>디지털/가전</td><td title=노트북>노트북</td><td title></td></tr></tbody></table></div><h3 id=bulk_load-활용-예시>bulk_load 활용 예시
<a class=anchor href=#bulk_load-%ed%99%9c%ec%9a%a9-%ec%98%88%ec%8b%9c>#</a></h3><ul><li><code>PostgresHook</code> 을 사용한 Operator에 이어서 <code>bulk_load()</code> 메서드를 추가</li><li>DAG 실행 날짜에 대응되는 디렉토리 아래의 <code>shop_with_tab.csv</code> 파일을 읽어서 <code>nshopping.search</code> 테이블에 업로드될 것을 기대</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.sdk</span> <span class=kn>import</span> <span class=n>DAG</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.providers.standard.operators.python</span> <span class=kn>import</span> <span class=n>PythonOperator</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pendulum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>DAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dag_id</span><span class=o>=</span><span class=s2>&#34;python_with_postgres_load&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>schedule</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=o>=</span><span class=n>pendulum</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=s2>&#34;Asia/Seoul&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>catchup</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;example&#34;</span><span class=p>,</span> <span class=s2>&#34;hook&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>as</span> <span class=n>dag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bulk_load_postgres</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>table_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>airflow.providers.postgres.hooks.postgres</span> <span class=kn>import</span> <span class=n>PostgresHook</span>
</span></span><span class=line><span class=cl>        <span class=n>postgres_hook</span> <span class=o>=</span> <span class=n>PostgresHook</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>postgres_hook</span><span class=o>.</span><span class=n>bulk_load</span><span class=p>(</span><span class=n>table_name</span><span class=p>,</span> <span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>postgres_task</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>task_id</span><span class=o>=</span><span class=s2>&#34;postgres_task&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>python_callable</span><span class=o>=</span><span class=n>bulk_load_postgres</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>op_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;postgres_conn_id&#34;</span><span class=p>:</span><span class=s2>&#34;conn-db-postgres-custom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;table_name&#34;</span><span class=p>:</span><span class=s2>&#34;nshopping.search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;file_name&#34;</span><span class=p>:</span><span class=s2>&#34;/opt/airflow/files/naverSearch/{{data_interval_end.in_timezone(</span><span class=se>\&#34;</span><span class=s2>Asia/Seoul</span><span class=se>\&#34;</span><span class=s2>) | ds_nodash }}/shop_with_tab.csv&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div></div><ul><li>DAG을 실행하고 DBeaver에서 <code>nshopping.search</code> 테이블을 조회하면 아래와 같이 CSV 파일이 그대로 올라온 것을 확인</li><li>하지만, CSV 헤더가 1행으로 들어가는 문제점이 보임</li></ul><p><img src="https://dl.dropboxusercontent.com/scl/fi/6lurqjuyz338xpnc8icr3/airflow-55-dbeaver-search-data.webp?rlkey=bjq0qwcguvuh96glzpq2kmy8h&amp;dl=0" alt="search > Data > [1] [rank, title, link, ...]"></p><h4 id=문제점-및-개선방안>문제점 및 개선방안
<a class=anchor href=#%eb%ac%b8%ec%a0%9c%ec%a0%90-%eb%b0%8f-%ea%b0%9c%ec%84%a0%eb%b0%a9%ec%95%88>#</a></h4><ul><li>문제점 : 구분자가 <code>Tab</code> 으로 고정되어 있고, 헤더까지 포함해서 업로드 됨</li><li>개선방안 : Custom Hook을 만들어서 구분자를 입력받고 헤더 포함 여부를 선택받게 함</li><li>Custom Hook은 다음 게시글에서 구현</li></ul><h2 id=custom-hook>Custom Hook
<a class=anchor href=#custom-hook>#</a></h2><a href=https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/hooks/base.html target=_blank class=bookmark-card><div class=bookmark-image><img src="https://dl.dropboxusercontent.com/scl/fi/jaltieh1sb4r7ozm6ju3e/airflow-00-cover-bg.webp?rlkey=s10wwm9o11zy79dwm1vje30sb&amp;dl=0" alt="airflow.hooks.base — Airflow 3.1.3 Documentation"></div><div class=bookmark-content><h3 class=bookmark-title>airflow.hooks.base — Airflow 3.1.3 Documentation</h3><small class=bookmark-url>airflow.apache.org</small></div></a><h3 id=basehook>BaseHook
<a class=anchor href=#basehook>#</a></h3><ul><li><code>BaseHook</code> 클래스를 상속받아 직접 만든 Hook을 사용 가능</li></ul><p><strong><code>get_connection()</code></strong></p><ul><li>Connection 객체를 가져오는 메서드</li><li><code>classmethod</code> 로 설정되어 있어 객체화하지 않고도 호출 가능</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Get connection, given connection id.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param conn_id: connection id
</span></span></span><span class=line><span class=cl><span class=s2>    :return: connection
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>airflow.models.connection</span> <span class=kn>import</span> <span class=n>Connection</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>Connection</span><span class=o>.</span><span class=n>get_connection_from_secrets</span><span class=p>(</span><span class=n>conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Connection Retrieved &#39;</span><span class=si>%s</span><span class=s2>&#39;&#34;</span><span class=p>,</span> <span class=n>conn</span><span class=o>.</span><span class=n>conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>conn</span></span></span></code></pre></div></div><p><strong><code>get_hook()</code></strong></p><ul><li>Connection 객체로부터 Hook 객체를 반환하는 메서드</li><li><code>classmethod</code> 로 설정되어 있어 객체화하지 않고도 호출 가능</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_hook</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>hook_params</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>BaseHook</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Return default hook for this connection id.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param conn_id: connection id
</span></span></span><span class=line><span class=cl><span class=s2>    :param hook_params: hook parameters
</span></span></span><span class=line><span class=cl><span class=s2>    :return: default hook for this connection
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>connection</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=n>conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>connection</span><span class=o>.</span><span class=n>get_hook</span><span class=p>(</span><span class=n>hook_params</span><span class=o>=</span><span class=n>hook_params</span><span class=p>)</span></span></span></code></pre></div></div><p><strong><code>get_conn()</code></strong></p><ul><li>Hook 객체에 대한 연결을 구현하는 메서드로, 반드시 재정의해야 함</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_conn</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Return connection for the hook.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>NotImplementedError</span><span class=p>()</span></span></span></code></pre></div></div><h3 id=postgreshook-개선점-파악>PostgresHook 개선점 파악
<a class=anchor href=#postgreshook-%ea%b0%9c%ec%84%a0%ec%a0%90-%ed%8c%8c%ec%95%85>#</a></h3><blockquote class=book-hint><p>이전에 만들었던 네이버 쇼핑 검색 결과에 대한 <a href=#bulk_load-%ed%99%9c%ec%9a%a9-%ec%98%88%ec%8b%9c>CSV 파일을 적재하는 PostgresHook</a>의 기능을 개선</p></blockquote><ol><li>구분자가 <code>Tab</code> 으로 고정되어 있고, 헤더까지 포함해서 업로드 됨<ul><li><a href=https://www.psycopg.org/docs/cursor.html#cursor.copy_expert target=_blank rel="noopener noreferrer">Psycopg 공식 문서</a>에 따르면,
<code>CSV HEADER</code> 구문을 뒤에 붙여 헤더를 제외할 수 있음</li><li>또한, <code>COPY</code> 문 뒤에 <code>DELIMITER</code> 구문을 추가해 구분자를 지정할 수도 있음</li></ul></li><li>테이블이 없으면 에러가 발생함, 또한 직접 테이블을 생성하는 것도 불편함<ul><li>CSV 파일의 헤더를 읽어서 <code>CREATE TABLE</code> 문을 만들고, 위 <code>COPY</code> 문 앞에 붙여서 테이블 생성</li><li>또한, 더 정확한 테이블 구성을 위해 모든 열을 <code>text</code> 타입으로 지정하지 않고, CSV 파일의 전체 또는 일부를
읽어서 <code>int4</code> 타입의 열을 추측할 수 있을 것이라 판단</li></ul></li><li>기존엔 데이터를 계속해서 추가했는데, 덮어쓰기 옵션을 통해 이전 데이터를 지울 수도 있으면 더 좋을 것이라 생각함</li></ol><h4 id=hook-기능-정의>Hook 기능 정의
<a class=anchor href=#hook-%ea%b8%b0%eb%8a%a5-%ec%a0%95%ec%9d%98>#</a></h4><blockquote class=book-hint><p>CSV 파일을 PostgreSQL 테이블에 적재하는데, 테이블이 없으면 생성하고, 덮어쓰기도 허용</p></blockquote><h2 id=custompostgreshook>CustomPostgresHook
<a class=anchor href=#custompostgreshook>#</a></h2><ul><li><code>BaseHook</code> 을 상속받는 <code>CustomPostgresHook</code> 를 구현</li><li>기본적인 구성은 <a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html target=_blank rel="noopener noreferrer">Postgres Provider 문서</a>에서
제공하는 소스코드를 참고</li><li>Hook 재사용을 위해 <code>plugins/</code> 경로 아래에 추가</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># plugins/hooks/postgres.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.hooks.base</span> <span class=kn>import</span> <span class=n>BaseHook</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Literal</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CustomPostgresHook</span><span class=p>(</span><span class=n>BaseHook</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>postgres_conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>postgres_conn_id</span> <span class=o>=</span> <span class=n>postgres_conn_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>database</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;database&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_conn</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>extensions</span><span class=o>.</span><span class=n>connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>BaseHook</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>postgres_conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>conn_args</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>login</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dbname&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>database</span> <span class=ow>or</span> <span class=n>conn</span><span class=o>.</span><span class=n>schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>conn_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bulk_load</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>if_exists</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;append&#34;</span><span class=p>,</span><span class=s2>&#34;replace&#34;</span><span class=p>]</span><span class=o>=</span><span class=s2>&#34;append&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=n>with_header</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>create</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_table_sql</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>,</span> <span class=n>sep</span><span class=p>,</span> <span class=n>with_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>replace</span> <span class=o>=</span> <span class=s2>&#34;TRUNCATE TABLE </span><span class=si>{}</span><span class=s2>;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>)</span> <span class=k>if</span> <span class=n>if_exists</span> <span class=o>==</span> <span class=s2>&#34;replace&#34;</span> <span class=k>else</span> <span class=nb>str</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>copy</span> <span class=o>=</span> <span class=s2>&#34;COPY </span><span class=si>{}</span><span class=s2> FROM STDIN DELIMITER &#39;</span><span class=si>{}</span><span class=s2>&#39; </span><span class=si>{}</span><span class=s2>;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>sep</span><span class=p>,</span> <span class=p>(</span><span class=s2>&#34;CSV HEADER&#34;</span> <span class=k>if</span> <span class=n>with_header</span> <span class=k>else</span> <span class=s2>&#34;CSV&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sql</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>create</span><span class=p>,</span> <span class=n>replace</span><span class=p>,</span> <span class=n>copy</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_create_table_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=n>with_header</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>with_header</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>column_list</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_csv_column_list</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>,</span> <span class=n>sep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;CREATE TABLE IF NOT EXISTS </span><span class=si>{}</span><span class=s2>(</span><span class=si>{}</span><span class=s2>);&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>column_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>str</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_read_csv_column_list</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>csv</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>is_int4_type</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=ow>not</span> <span class=n>value</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=ow>and</span> <span class=p>(</span><span class=o>-</span><span class=mi>2147483648</span> <span class=o>&lt;=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>2147483647</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=n>encoding</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reader</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>delimiter</span><span class=o>=</span><span class=n>sep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>header</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>dtypes</span> <span class=o>=</span> <span class=p>[</span><span class=nb>all</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>is_int4_type</span><span class=p>,</span> <span class=n>values</span><span class=p>))</span> <span class=k>for</span> <span class=n>values</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=nb>next</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)])]</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;, &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s2>&#34;</span><span class=si>{}</span><span class=s2> </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>col</span><span class=p>,</span> <span class=p>(</span><span class=s2>&#34;int4&#34;</span> <span class=k>if</span> <span class=n>is_int4</span> <span class=k>else</span> <span class=s2>&#34;text&#34;</span><span class=p>))</span> <span class=k>for</span> <span class=n>col</span><span class=p>,</span> <span class=n>is_int4</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=n>dtypes</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>copy_expert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>closing</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Running copy expert: </span><span class=si>%s</span><span class=s2>, filename: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=n>encoding</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_conn</span><span class=p>())</span> <span class=k>as</span> <span class=n>conn</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>())</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>file</span><span class=o>.</span><span class=n>truncate</span><span class=p>(</span><span class=n>file</span><span class=o>.</span><span class=n>tell</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span></span></code></pre></div></div><h3 id=postgresql-연결-메서드>PostgreSQL 연결 메서드
<a class=anchor href=#postgresql-%ec%97%b0%ea%b2%b0-%eb%a9%94%ec%84%9c%eb%93%9c>#</a></h3><p><strong><code>get_conn()</code></strong></p><ul><li><code>PostgresHook</code> 의 <a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.get_conn target=_blank rel="noopener noreferrer"><code>get_conn()</code></a>
메서드와 유사한데, 메서드를 호출할 때마다 <code>Connection</code> 객체를 가져와 연결 정보를 읽어오는데 차이가 있음</li><li><code>psycopg2</code> 라이브러리를 사용해 PostgreSQL에 연결하고 <code>psycopg2.extensions.connection</code> 객체를 반환</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_conn</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>extensions</span><span class=o>.</span><span class=n>connection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>BaseHook</span><span class=o>.</span><span class=n>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>postgres_conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>conn_args</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;host&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>login</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dbname&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>database</span> <span class=ow>or</span> <span class=n>conn</span><span class=o>.</span><span class=n>schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>conn</span><span class=o>.</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>conn_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>conn</span></span></span></code></pre></div></div><h3 id=쿼리문-생성-메서드>쿼리문 생성 메서드
<a class=anchor href=#%ec%bf%bc%eb%a6%ac%eb%ac%b8-%ec%83%9d%ec%84%b1-%eb%a9%94%ec%84%9c%eb%93%9c>#</a></h3><p><strong><code>bulk_load()</code></strong></p><ul><li><code>f"COPY {table} FROM STDIN"</code> 형식의 단순한 SQL문을 사용하던 기존
<a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.bulk_load target=_blank rel="noopener noreferrer"><code>bulk_load()</code></a> 메서드를 개선</li><li><strong><code>create</code></strong> : <code>_create_table_sql()</code> 메서드를 통해 <code>CREATE TABLE</code> 문 생성</li><li><strong><code>replace</code></strong> : <code>if_exists</code> 파라미터 값에 따라 테이블 내용을 모두 삭제하는 구문을 선택적으로 추가</li><li><strong><code>copy</code></strong> : 구분자 또는 헤더 포함 여부 등을 파라미터로 받고 이를 활용하여 <code>COPY</code> 문 생성</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>bulk_load</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>if_exists</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;append&#34;</span><span class=p>,</span><span class=s2>&#34;replace&#34;</span><span class=p>]</span><span class=o>=</span><span class=s2>&#34;append&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=n>with_header</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>create</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_table_sql</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>,</span> <span class=n>sep</span><span class=p>,</span> <span class=n>with_header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>replace</span> <span class=o>=</span> <span class=s2>&#34;TRUNCATE TABLE </span><span class=si>{}</span><span class=s2>;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>)</span> <span class=k>if</span> <span class=n>if_exists</span> <span class=o>==</span> <span class=s2>&#34;replace&#34;</span> <span class=k>else</span> <span class=nb>str</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>copy</span> <span class=o>=</span> <span class=s2>&#34;COPY </span><span class=si>{}</span><span class=s2> FROM STDIN DELIMITER &#39;</span><span class=si>{}</span><span class=s2>&#39; </span><span class=si>{}</span><span class=s2>;&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>sep</span><span class=p>,</span> <span class=p>(</span><span class=s2>&#34;CSV HEADER&#34;</span> <span class=k>if</span> <span class=n>with_header</span> <span class=k>else</span> <span class=s2>&#34;CSV&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sql</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>create</span><span class=p>,</span> <span class=n>replace</span><span class=p>,</span> <span class=n>copy</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>)</span></span></span></code></pre></div></div><p><strong><code>_create_table_sql()</code></strong></p><ul><li>헤더가 있을 경우에 한정해, <code>_read_csv_column_list()</code> 메서드를 통해 열 목록을 가져오고, <code>CREATE TABLE</code> 문 안에 열 목록을 포맷팅해 반환</li><li><code>IF NOT EXISTS</code> 구문을 추가해 테이블이 이미 존재할 경우는 테이블 생성 생략</li><li>헤더가 없을 경우에는 기본적으로 테이블 생성 무시</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_create_table_sql</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=n>with_header</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>with_header</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>column_list</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_csv_column_list</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>encoding</span><span class=p>,</span> <span class=n>sep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;CREATE TABLE IF NOT EXISTS </span><span class=si>{}</span><span class=s2>(</span><span class=si>{}</span><span class=s2>);&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>column_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>()</span></span></span></code></pre></div></div><p><strong><code>_read_csv_column_list()</code></strong></p><ul><li>헤더와 상위 5개 행을 읽어서 데이터 타입을 추정하고, 이를 바탕으로 테이블의 열 목록을 정의</li><li>데이터 타입은 <code>int4</code> 또는 <code>text</code> 두 가지 경우만 판단하며, <code>int4</code> 범위에 있는
숫자형 문자 또는 NULL 값으로만 구성된 열은 <code>int4</code> 타입으로 지정하고, 나머지는 <code>text</code> 타입으로 지정</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>_read_csv_column_list</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s1>&#39;,&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>csv</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_int4_type</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=ow>not</span> <span class=n>value</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=ow>and</span> <span class=p>(</span><span class=o>-</span><span class=mi>2147483648</span> <span class=o>&lt;=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>2147483647</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=n>encoding</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>reader</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>delimiter</span><span class=o>=</span><span class=n>sep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>header</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dtypes</span> <span class=o>=</span> <span class=p>[</span><span class=nb>all</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>is_int4_type</span><span class=p>,</span> <span class=n>values</span><span class=p>))</span> <span class=k>for</span> <span class=n>values</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=nb>next</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)])]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;, &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s2>&#34;</span><span class=si>{}</span><span class=s2> </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>col</span><span class=p>,</span> <span class=p>(</span><span class=s2>&#34;int4&#34;</span> <span class=k>if</span> <span class=n>is_int4</span> <span class=k>else</span> <span class=s2>&#34;text&#34;</span><span class=p>))</span> <span class=k>for</span> <span class=n>col</span><span class=p>,</span> <span class=n>is_int4</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>header</span><span class=p>,</span> <span class=n>dtypes</span><span class=p>)])</span></span></span></code></pre></div></div><h3 id=쿼리문-실행-메서드>쿼리문 실행 메서드
<a class=anchor href=#%ec%bf%bc%eb%a6%ac%eb%ac%b8-%ec%8b%a4%ed%96%89-%eb%a9%94%ec%84%9c%eb%93%9c>#</a></h3><p><strong><code>copy_expert()</code></strong></p><ul><li><code>PostgresHook</code> 의 <a href=https://airflow.apache.org/docs/apache-airflow-providers-postgres/6.1.3/_modules/airflow/providers/postgres/hooks/postgres.html#PostgresHook.copy_expert target=_blank rel="noopener noreferrer"><code>copy_expert()</code></a>
메서드와 동일한데, 한글 CSV 파일은 <code>EUC-KR</code> 등 다른 인코딩이 필요할 수 있어 <code>encoding</code> 파라미터를 추가</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>copy_expert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sql</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>closing</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Running copy expert: </span><span class=si>%s</span><span class=s2>, filename: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>sql</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=n>encoding</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_conn</span><span class=p>())</span> <span class=k>as</span> <span class=n>conn</span><span class=p>,</span> <span class=n>closing</span><span class=p>(</span><span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>())</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cur</span><span class=o>.</span><span class=n>copy_expert</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>file</span><span class=o>.</span><span class=n>truncate</span><span class=p>(</span><span class=n>file</span><span class=o>.</span><span class=n>tell</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span></span></code></pre></div></div><h2 id=custom-hook-활용-예시>Custom Hook 활용 예시
<a class=anchor href=#custom-hook-%ed%99%9c%ec%9a%a9-%ec%98%88%ec%8b%9c>#</a></h2><h3 id=dag-생성-및-실행>DAG 생성 및 실행
<a class=anchor href=#dag-%ec%83%9d%ec%84%b1-%eb%b0%8f-%ec%8b%a4%ed%96%89>#</a></h3><ul><li><code>plugins/</code> 에 정의한 <code>CustomPostgresHook</code> 을 활용</li><li>실행 날짜에 생성된 <code>shop.csv</code> 파일을 보고 <code>nshopping.search2</code> 테이블을 생성 및 적재</li><li><code>shop.csv</code> 파일을 굳이 <code>shop_with_tab.csv</code> 파일로 가공할 필요성을 줄여서 편의성 개선</li></ul><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># dags/python_with_postgres_custom.py</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.sdk</span> <span class=kn>import</span> <span class=n>DAG</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>airflow.providers.standard.operators.python</span> <span class=kn>import</span> <span class=n>PythonOperator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>hooks.postgres</span> <span class=kn>import</span> <span class=n>CustomPostgresHook</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pendulum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>DAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dag_id</span><span class=o>=</span><span class=s2>&#34;python_with_postgres_custom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>schedule</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>start_date</span><span class=o>=</span><span class=n>pendulum</span><span class=o>.</span><span class=n>datetime</span><span class=p>(</span><span class=mi>2025</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>tz</span><span class=o>=</span><span class=s2>&#34;Asia/Seoul&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>catchup</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;example&#34;</span><span class=p>,</span> <span class=s2>&#34;hook&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=k>as</span> <span class=n>dag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>bulk_load_postgres</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>table</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>custom_postgres_hook</span> <span class=o>=</span> <span class=n>CustomPostgresHook</span><span class=p>(</span><span class=n>postgres_conn_id</span><span class=o>=</span><span class=n>postgres_conn_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>custom_postgres_hook</span><span class=o>.</span><span class=n>bulk_load</span><span class=p>(</span><span class=n>table</span><span class=o>=</span><span class=n>table</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=n>filename</span><span class=p>,</span> <span class=n>if_exists</span><span class=o>=</span><span class=s2>&#34;replace&#34;</span><span class=p>,</span> <span class=n>sep</span><span class=o>=</span><span class=s2>&#34;,&#34;</span><span class=p>,</span> <span class=n>with_header</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bulk_load_postgres</span> <span class=o>=</span> <span class=n>PythonOperator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>task_id</span><span class=o>=</span><span class=s2>&#34;bulk_load_postgres&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>python_callable</span><span class=o>=</span><span class=n>bulk_load_postgres</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>op_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;postgres_conn_id&#34;</span><span class=p>:</span> <span class=s2>&#34;conn-db-postgres-custom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;table&#34;</span><span class=p>:</span><span class=s2>&#34;nshopping.search2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;filename&#34;</span><span class=p>:</span><span class=s2>&#34;/opt/airflow/files/naverSearch/{{data_interval_end.in_timezone(</span><span class=se>\&#34;</span><span class=s2>Asia/Seoul</span><span class=se>\&#34;</span><span class=s2>) | ds_nodash }}/shop.csv&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div></div><ul><li>실행 로그 중에서 <code>CustomPostgresHook</code> 이 생성한 SQL문을 확인 가능</li><li><code>if_exists="replace"</code> 파라미터를 추가했기 때문에, 중간에 <code>TRUNCATE TABLE</code> 구문이 추가<ul><li>따라서, 여러 번 DAG을 실행해도 매번 테이블이 초기화되어 중복된 데이터가 업로드되지 않음</li></ul></li></ul><div class=book-codeblock data-lang=bash><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">bash</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - DAG bundles loaded: dags-folder: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;airflow.dag_processing.bundles.manager.DagBundlesManager&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - Filling up the DagBag from /opt/airflow/dags/python_with_postgres_custom.py: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;airflow.models.dagbag.DagBag&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - Running copy expert: CREATE TABLE IF NOT EXISTS nshopping.search2<span class=o>(</span>rank int4, title text, link text, image text, lprice int4, hprice int4, mallName text, productId text, productType int4, brand text, maker text, category1 text, category2 text, category3 int4, category4 int4<span class=o>)</span><span class=p>;</span>TRUNCATE TABLE nshopping.search2<span class=p>;</span>COPY nshopping.search2 FROM STDIN DELIMITER <span class=s1>&#39;,&#39;</span> CSV HEADER<span class=p>;</span>, filename: /opt/airflow/files/naverSearch/20250611/shop.csv: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;hooks.postgres.CustomPostgresHook&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - Secrets backends loaded <span class=k>for</span> worker: <span class=nv>count</span><span class=o>=</span>1: <span class=nv>backend_classes</span><span class=o>=[</span><span class=s2>&#34;EnvironmentVariablesBackend&#34;</span><span class=o>]</span>: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;supervisor&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - Connection Retrieved <span class=s1>&#39;conn-db-postgres-custom&#39;</span>: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;airflow.hooks.base&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2025-06-11, 01:24:16<span class=o>]</span> INFO - Done. Returned value was: None: <span class=nv>source</span><span class=o>=</span><span class=s2>&#34;airflow.task.operators.airflow.providers.standard.operators.python.PythonOperator&#34;</span></span></span></code></pre></div></div><h3 id=테이블-조회>테이블 조회
<a class=anchor href=#%ed%85%8c%ec%9d%b4%eb%b8%94-%ec%a1%b0%ed%9a%8c>#</a></h3><ul><li>DBeaver에서 <code>nshopping.search2</code> 테이블이 생성되었고, 의도대로 정수형 열을 추측하여 데이터 타입을 구분해서 지정된 것을 확인</li></ul><div style=text-align:center><img src="https://dl.dropboxusercontent.com/scl/fi/7wxi8iful4mscw6hrbk4b/airflow-56-dbeaver-search2-columns.webp?rlkey=21gcfnuz4969c25nzmocd9kmc&amp;dl=0" alt="search2 > Properties > Columns" style=width:100%;max-width:691px></div><ul><li>테이블 내용을 보면, 기존의 문제였던 헤더가 1행으로 들어갔던게 해결됨이 확인</li><li>또한, 추측한 데이터 타입에 맞춰서 값이 정상적으로 들어갔음을 확인</li><li>참조한 강의에서는 CSV 파일을 <code>pd.DataFrame</code> 객체로 읽고, SQLAlchemy의 엔진을 사용해 <code>to_sql()</code> 기능으로 PostgreSQL 테이블에 데이터를 적재하는 방식으로 접근<ul><li>개인적으로는 <code>PostgresHook</code> 을 이해하고자, <code>PostgresHook</code> 의 원형을 최대한 유지하면서 필요한 기능만 추가하기 위해 외부 라이브러리의 사용을 제한함</li></ul></li></ul><p><img src="https://dl.dropboxusercontent.com/scl/fi/p2tb7a2tcjq69pfixzf6p/airflow-57-dbeaver-search2-data.webp?rlkey=0t6eb81t9ullwkfowhocrjrhx&amp;dl=0" alt="search2 > Data"></p></article><div class=book-nav><button class=book-nav-btn3 onclick='window.scrollTo({top:0,behavior:"smooth"})' title="Go to top">
<i class="fa fa-chevron-up"></i>
</button>
<button class=book-nav-btn3 onclick='window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})' title="Go to bottom">
<i class="fa fa-chevron-down"></i>
<button class=book-nav-btn3 onclick=history.back() title="Go back">
<i class="fa-solid fa-arrow-left"></i></button></div><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class=post-tags><a href=/tags/apache-airflow/ class=tag>#Apache Airflow</a>
<a href=/tags/connection/ class=tag>#Connection</a>
<a href=/tags/hook/ class=tag>#Hook</a>
<a href=/tags/docker-compose/ class=tag>#Docker Compose</a>
<a href=/tags/postgres/ class=tag>#Postgres</a>
<a href=/tags/custom-hook/ class=tag>#Custom Hook</a>
<a href=/tags/%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%97%94%EC%A7%80%EB%8B%88%EC%96%B4%EB%A7%81/ class=tag>#데이터 엔지니어링</a>
<a href=/tags/%EC%97%90%EC%96%B4%ED%94%8C%EB%A1%9C%EC%9A%B0/ class=tag>#에어플로우</a>
<a href=/tags/python/ class=tag>#Python</a>
<a href=/tags/study/ class=tag>#Study</a></div><div class=post-navigation><a href=/blog/airflow-study-6/ class="post-nav-link post-nav-prev"><span class=post-nav-direction><i class="fa-solid fa-backward"></i> PREV</span>
<span class=post-nav-title>Apache Airflow - REST API 연동과 Custom Operator 구현</span>
</a><a href class="post-nav-link post-nav-next post-nav-disabled"><span class=post-nav-direction>NEXT <i class="fa-solid fa-forward"></i></span>
<span class=post-nav-title>다음 게시글이 없습니다</span></a></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=book-comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://minyeamer.github.io/blog/airflow-study-7/",this.page.identifier="https://minyeamer.github.io/blog/airflow-study-7/"};(function(){var e=document,t=e.createElement("script");t.src="https://minyeamer.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})();function reloadDisqus(){window.DISQUS&&DISQUS.reset({reload:!0,config:function(){this.page.url="https://minyeamer.github.io/blog/airflow-study-7/",this.page.identifier="https://minyeamer.github.io/blog/airflow-study-7/"}})}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#docker-compose-이해>Docker Compose 이해</a></li><li><a href=#postgres-컨테이너-생성>Postgres 컨테이너 생성</a><ul><li><a href=#docker-compose>Docker Compose</a></li><li><a href=#dbeaver-접속>DBeaver 접속</a></li><li><a href=#postgres-테이블-생성>Postgres 테이블 생성</a></li><li><a href=#pythonoperator>PythonOperator</a></li></ul></li><li><a href=#connection--hook>Connection & Hook</a><ul><li><a href=#postgres-provider-문서-보기>Postgres Provider 문서 보기</a></li><li><a href=#connection-추가>Connection 추가</a></li><li><a href=#postgreshook>PostgresHook</a></li></ul></li><li><a href=#bulk_load>bulk_load</a><ul><li><a href=#postgres-provider-문서-보기-1>Postgres Provider 문서 보기</a></li><li><a href=#postgres-테이블-생성-1>Postgres 테이블 생성</a></li><li><a href=#csv-파일-가공>CSV 파일 가공</a></li><li><a href=#bulk_load-활용-예시>bulk_load 활용 예시</a></li></ul></li><li><a href=#custom-hook>Custom Hook</a><ul><li><a href=#basehook>BaseHook</a></li><li><a href=#postgreshook-개선점-파악>PostgresHook 개선점 파악</a></li></ul></li><li><a href=#custompostgreshook>CustomPostgresHook</a><ul><li><a href=#postgresql-연결-메서드>PostgreSQL 연결 메서드</a></li><li><a href=#쿼리문-생성-메서드>쿼리문 생성 메서드</a></li><li><a href=#쿼리문-실행-메서드>쿼리문 실행 메서드</a></li></ul></li><li><a href=#custom-hook-활용-예시>Custom Hook 활용 예시</a><ul><li><a href=#dag-생성-및-실행>DAG 생성 및 실행</a></li><li><a href=#테이블-조회>테이블 조회</a></li></ul></li></ul></nav></div></aside></main></body></html>