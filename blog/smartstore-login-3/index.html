<!doctype html><html lang=ko-kr dir=ltr><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><meta name=keywords content="크롤링,Python,네이버,스마트스토어,OAuth 인증,GraphQL,2단계 인증,requests,쿠키 인증,웹 자동화"><meta name=description content="네이버 스마트스토어센터 로그인 최종 구현 방법입니다. OAuth 인증, GraphQL 쿼리, oauth_token 추출, 2단계 인증 처리를 통해 필요한 모든 쿠키 값을 획득하는 …"><meta name=author content="minyeamer"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><link rel=canonical href=https://minyeamer.github.io/blog/smartstore-login-3/><link rel=icon href=https://minyeamer.github.io/images/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://minyeamer.github.io/images/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://minyeamer.github.io/images/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://minyeamer.github.io/images/favicons/apple-touch-icon.png><link rel=mask-icon href=https://minyeamer.github.io/images/favicons/apple-touch-icon.png><meta name=google-site-verification content="u1tWcHmHUZWfFT1cHaku6sqU-bK40N3WLR-C-4VUWN0"><meta name=naver-site-verification content="6eaf8e9da1a6104780f056f1a7797fe5a3a5a0da"><meta property="og:title" content="[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)"><meta property="og:description" content="네이버 스마트스토어센터 로그인 최종 구현 방법입니다. OAuth 인증, GraphQL 쿼리, oauth_token 추출, 2단계 인증 처리를 통해 필요한 모든 쿠키 값을 획득하는 …"><meta property="og:type" content="article"><meta property="og:url" content="https://minyeamer.github.io/blog/smartstore-login-3/"><meta property="og:image" content="https://dl.dropboxusercontent.com/scl/fi/bghhh0kkkr4ssaw5a10ri/smartstore-login-00-main-wide.webp?rlkey=014mj9c15aymkvseohy0dtqih&amp;dl=0"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-04T10:22:03+09:00"><meta property="article:modified_time" content="2022-12-04T10:22:03+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dl.dropboxusercontent.com/scl/fi/bghhh0kkkr4ssaw5a10ri/smartstore-login-00-main-wide.webp?rlkey=014mj9c15aymkvseohy0dtqih&amp;dl=0"><meta name=twitter:title content="[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)"><meta name=twitter:description content="네이버 스마트스토어센터 로그인 최종 구현 방법입니다. OAuth 인증, GraphQL 쿼리, oauth_token 추출, 2단계 인증 처리를 통해 필요한 모든 쿠키 값을 획득하는 …"><meta name=twitter:site content="@https://x.com/minyeamer"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://minyeamer.github.io/posts/"},{"@type":"ListItem","position":2,"name":"[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)","item":"https://minyeamer.github.io/blog/smartstore-login-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)","name":"[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)","description":"네이버 스마트스토어센터 로그인 최종 구현 방법입니다. OAuth 인증, GraphQL 쿼리, oauth_token 추출, 2단계 인증 처리를 통해 필요한 모든 쿠키 값을 획득하는 과정을 설명합니다.\n","keywords":["크롤링","Python","네이버","스마트스토어","OAuth 인증","GraphQL","2단계 인증","requests","쿠키 인증","웹 자동화"],"articleBody":"앞선 네이버 로그인 구현 과정을 통해 네이버 로그인에 대해 이해하고 스마트스토어센터 로그인 결과로 얻을 수 있는 쿠키 값의 일부를 획득했습니다.\nCopy python cookies = { \"NNB\": \"...\", \"nid_inf\": \"...\", \"NID_AUT\": \"...\", \"NID_SES\": \"...\", \"NID_JKL\": \"...\", \"CBI_SES\": \"...\", \"CBI_CHK\": \"...\", \"NSI\": \"...\", } 하지만, 스마트스토어센터에서 데이터를 가져오기 위해 필요한 쿠키 값은 CBI_SES, CBI_CHK, NSI 세 가지 값이기 때문에 지금까지는 준비 과정에 불과했다고 할 수 있습니다.\n이번 게시글에서는 스마트스토어센터 로그인 과정을 이해하고 직접 구현해보면서 SmartstoreLogin 클래스를 완성해보겠습니다.\n스마트스토어센터 로그인 이해 # 지금까지 스마트스토어센터의 두 가지 로그인 방식 중 네이버 로그인 방식으로 로그인을 수행하기 위해, 실제 네이버 로그인에 대한 이해 및 구현을 진행했습니다.\n요청 내역 탐색 시 주의사항 # 새 창에서 띄워지는 네이버 로그인 페이지는 로그인이 완료되면 닫혀버리기 때문에 네트워크 요청 내역을 확인하기 어렵습니다.\n이 경우 개발자 도구 Sources 탭에서 Event Listener Breakpoints 메뉴 아래 Window \u003e window.close 부분을 선택하면 창이 닫히는 순간에 중단시킬 수 있습니다.\n네이버 로그인과의 차이점 # 스마트스토어센터 로그인에서의 네이버 로그인은 기존 방식과 다소의 차이점이 존재합니다.\n아래는 스마트스토어센터 로그인 POST 요청에서 확인할 수 있는 데이터입니다.\nCopy json { \"localechange\": \"\", \"dynamicKey\": \"...\", \"logintp\": \"oauth2\", \"encpw\": \"...\", \"enctp\": 1, \"svctype\": 64, \"smart_LEVEL\": 1, \"bvsd\": { \"uuid\":\"...\", \"encData\":\"...\" }, \"encnm\": \"...\", \"locale\": \"ko_KR\", \"client_id\": \"...\", \"url\": \"https://nid.naver.com/oauth2.0/authorize?response_type=code\u0026state=...\u0026client_id=...\u0026redirect_uri=https%3A%2F%2Faccounts.commerce.naver.com%2Foauth%2Fcallback\u0026locale=ko_KR\u0026inapp_view=\u0026oauth_os=\", \"id\": \"\", \"pw\": \"\" } 기존의 네이버 로그인 데이터와 비교했을 때 3개의 값이 추가되었음을 알 수 있습니다.\nlogintp 의 경우 \"oauth2\" 로 고정된 값으로 보이지만, url 내 state 와 client_id 는 지금까지의 과정에서는 얻을 수 없었던 새로운 값으로 로그인을 위해 추가적인 동작이 필요해 보입니다.\nOAuth URL 가져오기 # state 와 client_id 의 경우 네이버 로그인 페이지를 불러오는 과정에서 이미 전달되는 값이기 때문에 해당 페이지 안에서는 출처를 찾을 수 없었습니다.\n따라서 네이버 로그인 페이지로 이동하기 위해 거치는 스마트스토어센터 로그인 페이지에서 네이버 로그인 페이지를 띄우는 과정에 집중하여 두 값이 발생하는 지점을 찾아보았고, graphql 주소로 보낸 POST 요청에 대한 응답으로 url 에 해당하는 authUrl 값을 받는 것을 확인했습니다.\n이렇게 구한 client_id 및 url 값을 로그인 데이터에 담아 요청을 보낼 경우 일반적인 네이버 로그인 결과로 얻을 수 있는 NID_AUT 등의 쿠키 값을 획득할 수 있습니다.\nGraphQL 로그인 분석 # 스마트스토어센터 로그인은 네이버 로그인에서 그치지 않고 CBI_SES, CBI_CHK, NSI 쿠키 값을 추가로 얻어야 합니다.\n이 중에서 CBI_SES 를 응답 파일 내에서 검색했을 때 graphql 주소에 대한 응답으로 CBI_SES 와 CBI_CHK 값을 반환하는 것을 알 수 있었습니다.\n해당 주소는 앞서 인증 주소를 가져오는 과정에서 보았던 것인데 당시 snsLoginBegin 라는 명칭의 쿼리와는 다른 snsLoginCallback 쿼리를 사용하여 추가적인 로그인을 수행하는 것임을 짐작할 수 있습니다.\n변수로 전달되는 state 의 경우 앞에서 구한 것과 동일한 값이지만, code 는 아직까지 본 적 없는 값입니다.\n하지만, code 는 어떠한 응답 파일 내에서도 출처를 찾아볼 수 없고, code 의 값 자체를 검색했을 때 oauth_token 이라는 키와 동일한 값을 사용한다는 것 말고는 별다른 단서를 찾을 수 없었습니다.\n이 경우 네이버 로그인 후에 연속적으로 진행되는 다른 요청 내역을 직접 들여다봐야 했고, 다행히 바로 아래의 주소에 대한 응답 내역에서 oauth_token 값을 받아볼 수 있었습니다.\nCopy html \u003chtml\u003e \u003cscript language=javascript nonce=\"4SzeR1mCGzDbnzr3s5rjQ1Li\"\u003e location.replace(\"https://nid.naver.com/login/noauth/allow_oauth.nhn?oauth_token=...\u0026with_pin\u0026step=agree_term\u0026inapp_view=\u0026oauth_os=\"); \u003c/script\u003e \u003c/html\u003e oauth_token 의 값을 code 에 넣어서 state 와 함께 graphql 주소에 요청할 경우 응답 헤더의 Set-Cookie 에서 볼 수 있는 CBI_SES 와 CBI_CHK 를 받게 됩니다.\n2단계 인증 분석 # 스마트스토어센터는 최초 로그인 시 반드시 2단계 인증을 거쳐야 합니다.\n마지막 남은 NSI 값 또한 해당 2단계 인증을 거쳐야 얻을 수 있을 것이라 걱정했지만, 다행히 2단계 인증을 거치지 않아도 네트워크 응답 내역에서 NSI를 확인할 수 있었습니다.\nPOST 요청이지만 전달되는 데이터는 아래와 같이 단순했기에 추가적인 분석 없이 마지막 NSI 값을 획득했습니다.\nCopy json {\"url\": \"https://sell.smartstore.naver.com/#/home/dashboard\"} 스마트스토어센터 로그인 구현 # 지금까지의 과정을 통해 스마트스토어센터에서 데이터를 가져오기 위해 필요한 CBI_SES, CBI_CHK, NSI 값을 획득하는 방법을 파악했습니다.\n이를 SmartstoreLogin 클래스의 메소드로 구현해보겠습니다.\n네이버 로그인 구현 # 기존의 네이버 로그인 기능에 OAuth URL을 가져오는 부분을 추가시킨 nid_login() 및 fetch_oauth_url() 메소드를 정의합니다.\nCopy python SMARTSTORE_URL = \"https://sell.smartstore.naver.com/\" SLOGIN_URL = \"https://accounts.commerce.naver.com\" GRAPHQL_DATA = str({ \"operationName\": \"snsLoginBegin\", \"variables\": { \"mode\": \"login\", \"snsCd\": \"naver\", \"svcUrl\": \"https://sell.smartstore.naver.com/#/login-callback\"}, \"query\": \"mutation snsLoginBegin($mode: String!, $snsCd: String!, $svcUrl: String!, \\ $oneTimeLoginSessionKey: String, $userInfos: [UserInfoEntry!]) {\\n snsBegin(\\n \\ snsLoginBeginRequest: {mode: $mode, snsCd: $snsCd, svcUrl: $svcUrl, oneTimeLoginSessionKey: \\ $oneTimeLoginSessionKey, userInfos: $userInfos}\\n ) {\\n authUrl\\n __typename\\n }\\n}\\n\" }).replace('\\'','\\\"') class SmartstoreLogin(NaverLogin): def fetch_oauth_url(self): referer = f\"{SLOGIN_URL}/login?url={SMARTSTORE_URL}#/login-callback\" headers = self.get_headers(host=SLOGIN_URL, referer=referer) response = self.post(urljoin(SLOGIN_URL, \"graphql\"), data=GRAPHQL_DATA, headers=headers) self.oauth_url = json.loads(response.text)[\"data\"][\"snsBegin\"][\"authUrl\"] self.oauth_params = {k:v.pop() for k,v in parse_qs(urlparse(self.oauth_url).query).items()} if \"auth_type\" in self.oauth_params: self.oauth_params.pop(\"auth_type\") self.oauth_params = dict(self.oauth_params, **{\"locale\":\"ko_KR\",\"inapp_view\":'',\"oauth_os\":''}) graphql 주소에 대한 요청 데이터를 그대로 구현한 것이 GRAPHQL_DATA이며, 그 결과로 OAuth URL을 얻을 수 있습니다.\nOAuth URL의 파라미터는 향후 GraphQL 인증 과정에서 재활용되기 때문에 oauth_params 변수에 저장해둡니다.\nCopy python LOGIN_URL = \"https://nid.naver.com/nidlogin.login\" SLOGIN_DATA = lambda dynamicKey, encpw, bvsd, encnm, client_id: \\ dict(LOGIN_DATA(dynamicKey, encpw, bvsd, encnm), **{\"logintp\":\"oauth2\",\"svctype\":\"64\",\"client_id\":client_id}) class SmartstoreLogin(NaverLogin): def nid_login(self): self.fetch_keys() self.set_encpw() self.set_bvsd() self.fetch_oauth_url() data = SLOGIN_DATA(self.dynamicKey, self.encpw, self.bvsd, self.encnm, self.oauth_params.get(\"client_id\")) headers = self.get_headers(LOGIN_URL, referer=self.oauth_url) headers[\"Content-Type\"] = \"application/x-www-form-urlencoded\" headers[\"Upgrade-Insecure-Requests\"] = \"1\" response = self.post(LOGIN_URL, data=data, headers=headers) 네이버 로그인 과정에서는 bvsd 를 생성한 후 OAuth URL을 추가로 가져오고 client_id 를 기존의 로그인 데이터 내에 포함시켜 POST 요청을 보냅니다.\n해당 메소드의 결과로 NID_AUT, NID_JKL, NID_SES 를 부여받을 수 있습니다.\nOAuth 로그인 구현 # OAuth 로그인은 네이버 로그인과 GraphQL 인증으로 구성됩니다.\n현시점에서 GraphQL 인증에 필요한 것은 oauth_token 뿐이기 때문에 앞선 네이버 로그인 과정에서 획득한 주소로부터 oauth_token 을 가져오는 메소드 fetch_oauth_token()과 전체적인 OAuth 로그인 과정을 구현한 oauth_login() 메소드를 정의합니다.\nCopy python OAUTH_URL = \"https://nid.naver.com/oauth2.0/authorize\" class SmartstoreLogin(NaverLogin): def fetch_oauth_token(self): headers = self.get_headers(LOGIN_URL, referer=LOGIN_URL, cookies=self.get_cookies()) response = self.get(OAUTH_URL, headers=headers, params=self.oauth_params) if re.search(\"(?\u003c=oauth_token\\=)(.*?)(?=\u0026)\", response.text): self.oauth_token = re.search(\"(?\u003c=oauth_token\\=)(.*?)(?=\u0026)\", response.text).group() Copy python OAUTH_DATA = lambda code, state: str({ \"operationName\":\"snsLoginCallback\", \"variables\": { \"code\": code, \"state\": state}, \"query\":\"mutation snsLoginCallback($code: String!, $state: String!) \\ {\\n snsCallback(snsLoginCallbackRequest: {code: $code, state: $state}) \\ {\\n statCd\\n loginStatus\\n nextUrl\\n sessionKey\\n snsCd\\n \\ idNo\\n realnm\\n age\\n email\\n __typename\\n }\\n}\\n\" }).replace('\\'','\\\"') class SmartstoreLogin(NaverLogin): def oauth_login(self): self.nid_login() self.fetch_oauth_token() code, state = self.oauth_token, self.oauth_params.get(\"state\") referer = SLOGIN_URL+f\"/oauth/callback?code={code}\u0026state={state}\" headers = self.get_headers(host=SLOGIN_URL, referer=referer, cookies=self.get_cookies()) response = self.post(urljoin(SLOGIN_URL, \"graphql\"), data=OAUTH_DATA(code, state), headers=headers) 2단계 인증 구현 # 2단계 인증을 직접 수행할 필요는 없습니다.\nNSI 쿠키 값을 할당받을 수 있는 주소로 POST 요청을 보내는 two_factor_login() 메소드를 정의합니다.\nCopy python TWOLOGIN_URL = SMARTSTORE_URL+\"api/login?url=https%3A%2F%2Fsell.smartstore.naver.com%2F%23%2Fhome%2Fdashboard\" TWOLOGIN_DATA = {\"url\": \"https://sell.smartstore.naver.com/#/home/dashboard\"} class SmartstoreLogin(NaverLogin): def two_factor_login(self): headers = self.get_headers(SMARTSTORE_URL, referer=SMARTSTORE_URL, cookies=self.get_cookies()) headers[\"Content-Type\"] = \"application/json;charset=UTF-8\" headers[\"x-current-state\"] = \"https://sell.smartstore.naver.com/#/login-callback\" headers[\"x-current-statename\"] = \"login-callback\" headers[\"x-to-statename\"] = \"login-callback\" response = self.post(TWOLOGIN_URL, data=TWOLOGIN_DATA, headers=headers) 로그인 메소드 구현 # SmartstoreLogin 객체를 사용할 때는 login() 메소드를 활용합니다.\nCopy python class SmartstoreLogin(NaverLogin): def login(self): email_pattern = re.compile(\"[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+\") self.seller_login() if email_pattern.search(self.userid) else self.oauth_login() self.two_factor_login() 향후 판매자 계정으로 로그인 하는 경우를 고려해 userid가 이메일인 경우 seller_login() 이라는 미구현된 메소드를 실행하도록 정의했습니다.\n일반적인 네이버 아이디를 사용할 경우엔 OAuth 로그인과 2단계 인증을 거쳐 처음 목적으로 했던 아래의 모든 쿠키 값을 획득하게 됩니다.\nCopy python cookies = { \"NNB\": \"...\", \"nid_inf\": \"...\", \"NID_AUT\": \"...\", \"NID_SES\": \"...\", \"NID_JKL\": \"...\", \"CBI_SES\": \"...\", \"CBI_CHK\": \"...\", \"NSI\": \"...\", } 해당 쿠키를 가진 SmartstoreLogin 객체를 세션 객체로 활용한다면 스마트스토어센터 내 어떤 데이터라도 파이썬 requests 모듈로 가져올 수 있게 됩니다.\n","wordCount":"1088","inLanguage":"en","image":"https:\/\/dl.dropboxusercontent.com\/scl\/fi\/bghhh0kkkr4ssaw5a10ri\/smartstore-login-00-main-wide.webp?rlkey=014mj9c15aymkvseohy0dtqih\u0026dl=0","datePublished":"2022-12-04T10:22:03+09:00","dateModified":"2022-12-04T10:22:03+09:00","author":{"@type":"Person","name":"minyeamer"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minyeamer.github.io/blog/smartstore-login-3/"},"publisher":{"@type":"Person","name":"Minystory","logo":{"@type":"ImageObject","url":"https://minyeamer.github.io/images/favicons/favicon.ico"}}}</script><title>[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3) | Minystory</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://minyeamer.github.io/blog/smartstore-login-3/><link rel=stylesheet href=/book.min.da9f864e1bccfac13510edef0c8dbe217c58d1ba58855d698051f162d9101fc5.css integrity="sha256-2p+GThvM+sE1EO3vDI2+IXxY0bpYhV1pgFHxYtkQH8U=" crossorigin=anonymous><link rel=preload href=/search/data.min.24a3328167599465f552b8934a19a8486143a00af808144b229e8ae17a457b15.json as=fetch crossorigin><script>window.SEARCH_DATA_URL="/search/data.min.24a3328167599465f552b8934a19a8486143a00af808144b229e8ae17a457b15.json"</script><script defer src=/fuse.min.js></script><script defer src=/search/fuse.min.eae8ae4ef59a64af10c06c4a7e6fb69032ed2f075221cc65a21931df8fbf06b8.js integrity="sha256-6uiuTvWaZK8QwGxKfm+2kDLtLwdSIcxlohkx34+/Brg=" crossorigin=anonymous></script><script defer src=/search/input.min.eed8c2f0b355986191da634451983f5f8cb56014f0948e1a8b88ee9a9e8bd2e1.js integrity="sha256-7tjC8LNVmGGR2mNEUZg/X4y1YBTwlI4ai4jump6L0uE=" crossorigin=anonymous></script><script defer src=/search/list.min.9785f8bf1e0d543779948953b450608b8ca202afe4c2e9faac6733388dcf12ce.js integrity="sha256-l4X4vx4NVDd5lIlTtFBgi4yiAq/kwun6rGczOI3PEs4=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BJ8Z9RMBPJ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BJ8Z9RMBPJ")</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css crossorigin=anonymous><script defer src=/scroll-progress.min.841ade7e507a5f6d59c4e7bf2fe2b2ca034070677ff7957eec55610a024dd776.js integrity="sha256-hBreflB6X21ZxOe/L+KyygNAcGd/95V+7FVhCgJN13Y=" crossorigin=anonymous></script><script defer src=/dark-mode.min.e41c6440ffd9967d6f6a419ff3ce09b862009fe1646ab265f5cb2817d2a508e3.js integrity="sha256-5BxkQP/Zln1vakGf884JuGIAn+FkarJl9csoF9KlCOM=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.9.0/highlightjs-line-numbers.min.js></script><script defer src=/copy-code.min.aaeef965f0b4992e55f976edaecb34a89d414e1791caa18c3f4f4376c6d8b5a8.js integrity="sha256-qu75ZfC0mS5V+Xbtrss0qJ1BTheRyqGMP09DdsbYtag=" crossorigin=anonymous></script><script defer src=/toc-highlightjs.093016f0ef312174ad862fdcf5792e88ab5442bd39beecc38d15643f71ab5c31.min integrity="sha256-CTAW8O8xIXSthi/c9XkuiKtUQr05vuzDjRVkP3GrXDE=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-posts book-layout-post"><div class=scroll-progress><div class=scroll-progress-bar></div></div><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><div class=sidebar-profile><div class=profile-img-wrap><a href=https://minyeamer.github.io/><img src=/images/profile/menu.jpg alt=Profile class=profile-img></a></div><div class=sidebar-social><a href=https://github.com/minyeamer target=_blank title=GitHub><i class="fa-brands fa-github"></i>
</a><a href=/categories/ title=Categories><i class="fa-solid fa-folder"></i>
</a><a href=/tags/ title=Tags><i class="fa-solid fa-tags"></i>
</a><button id=dark-mode-toggle class=dark-mode-toggle aria-label="Toggle dark mode">
<i class="fa-solid fa-circle-half-stroke"></i></button></div></div><h2 class=book-brand><a class="flex align-center" href=/><span>Minystory</span></a></h2><div class="book-search hidden"><div class=search-input-container><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/ onkeydown='event.key==="Enter"&&goToSearchPage()'>
<button type=button id=book-search-button class=book-search-btn onclick=goToSearchPage()>
<i class="fa-solid fa-magnifying-glass"></i></button></div><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden");function goToSearchPage(){const t=document.getElementById("book-search-input"),e=t.value.trim();e&&(window.location.href="/search/?q="+encodeURIComponent(e))}</script><div class=book-categories><input type=checkbox class="hidden toggle" id=categories-control checked>
<label for=categories-control class="categories-toggle categories-link"><a href=/categories/><i class="fa-solid fa-folder"></i>
<span>전체</span>
<span class=category-count>(39)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul class=categories-menu id=categories-menu><li><input type=checkbox class="hidden toggle" id=cat-algorithm>
<label for=cat-algorithm class="categories-toggle categories-link"><a href=/categories/algorithm/><i class="fa-solid fa-folder"></i>
Algorithm
<span class=category-count>(4)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/algorithm/graph/><i class="fa-solid fa-file"></i>
Graph
<span class=category-count>(1)</span></a></li><li class=categories-link><a href=/categories/algorithm/python/><i class="fa-solid fa-file"></i>
Python
<span class=category-count>(2)</span></a></li><li class=categories-link><a href=/categories/algorithm/sql/><i class="fa-solid fa-file"></i>
SQL
<span class=category-count>(1)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-cloud>
<label for=cat-cloud class="categories-toggle categories-link"><a href=/categories/cloud/><i class="fa-solid fa-folder"></i>
Cloud
<span class=category-count>(2)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/cloud/kubernetes/><i class="fa-solid fa-file"></i>
Kubernetes
<span class=category-count>(2)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-data-analysis>
<label for=cat-data-analysis class="categories-toggle categories-link"><a href=/categories/data-analysis/><i class="fa-solid fa-folder"></i>
Data Analysis
<span class=category-count>(3)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/data-analysis/dacon/><i class="fa-solid fa-file"></i>
Dacon
<span class=category-count>(3)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-data-engineering>
<label for=cat-data-engineering class="categories-toggle categories-link"><a href=/categories/data-engineering/><i class="fa-solid fa-folder"></i>
Data Engineering
<span class=category-count>(19)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/data-engineering/apache-airflow/><i class="fa-solid fa-file"></i>
Apache Airflow
<span class=category-count>(7)</span></a></li><li class=categories-link><a href=/categories/data-engineering/apache-spark/><i class="fa-solid fa-file"></i>
Apache Spark
<span class=category-count>(8)</span></a></li><li class=categories-link><a href=/categories/data-engineering/crawling/><i class="fa-solid fa-file"></i>
Crawling
<span class=category-count>(4)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-frontend>
<label for=cat-frontend class="categories-toggle categories-link"><a href=/categories/frontend/><i class="fa-solid fa-folder"></i>
Frontend
<span class=category-count>(8)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/frontend/blog/><i class="fa-solid fa-file"></i>
Blog
<span class=category-count>(8)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-linux>
<label for=cat-linux class="categories-toggle categories-link"><a href=/categories/linux/><i class="fa-solid fa-folder"></i>
Linux
<span class=category-count>(1)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/linux/ubuntu/><i class="fa-solid fa-file"></i>
Ubuntu
<span class=category-count>(1)</span></a></li></ul></li><li><input type=checkbox class="hidden toggle" id=cat-project>
<label for=cat-project class="categories-toggle categories-link"><a href=/categories/project/><i class="fa-solid fa-folder"></i>
Project
<span class=category-count>(2)</span>
</a><i class="fa-solid fa-chevron-down categories-arrow"></i></label><ul><li class=categories-link><a href=/categories/project/open-source/><i class="fa-solid fa-file"></i>
Open Source
<span class=category-count>(1)</span></a></li><li class=categories-link><a href=/categories/project/tools/><i class="fa-solid fa-file"></i>
Tools
<span class=category-count>(1)</span></a></li></ul></li></ul></div><div class=recent-posts><div class=recent-posts-header><i class="fa-solid fa-clock"></i>
<span>최신글</span></div><ul class=recent-posts-list><li class=recent-post-item><a href=/blog/hugo-blog-4/ title="Hugo 블로그 만들기 (4) - 검색 기능 개선 및 검색 페이지 구현 (Fuse.js)"><div class=recent-post-title>Hugo 블로그 만들기 (4) - 검색 기능 개선 및 검색 페이지 구현 (Fuse.js)</div><div class=recent-post-date><time datetime=2025-12-14>2025.12.14</time></div></a></li><li class=recent-post-item><a href=/blog/hugo-blog-3/ title="Hugo 블로그 만들기 (3) - Taxonomies로 태그/카테고리 페이지 커스터마이징"><div class=recent-post-title>Hugo 블로그 만들기 (3) - Taxonomies로 태그/카테고리 페이지 커스터마이징</div><div class=recent-post-date><time datetime=2025-11-22>2025.11.22</time></div></a></li><li class=recent-post-item><a href=/blog/hugo-blog-2/ title="Hugo 블로그 만들기 (2) - 메인 레이아웃 커스터마이징 (메뉴, 목차, 헤더)"><div class=recent-post-title>Hugo 블로그 만들기 (2) - 메인 레이아웃 커스터마이징 (메뉴, 목차, 헤더)</div><div class=recent-post-date><time datetime=2025-11-04>2025.11.04</time></div></a></li><li class=recent-post-item><a href=/blog/hugo-blog-1/ title="Hugo 블로그 만들기 (1) - 프로젝트 구성과 GitHub Pages 배포 (Submodule 활용)"><div class=recent-post-title>Hugo 블로그 만들기 (1) - 프로젝트 구성과 GitHub Pages 배포 (Submodule 활용)</div><div class=recent-post-date><time datetime=2025-11-01>2025.11.01</time></div></a></li><li class=recent-post-item><a href=/blog/openup-handson/ title="[OSSCA] 2025 오픈소스 컨트리뷰션 아카데미 - PyTorch 문서 한글화 참여 후기"><div class=recent-post-title>[OSSCA] 2025 오픈소스 컨트리뷰션 아카데미 - PyTorch 문서 한글화 참여 후기</div><div class=recent-post-date><time datetime=2025-10-28>2025.10.28</time></div></a></li></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><i class="fa-solid fa-bars book-icon" id=menu-icon></i></label><h3><a href=https://minyeamer.github.io/ class=site-title>Minystory</a></h3><label for=toc-control><i class="fa-solid fa-list book-icon" id=toc-icon></i></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#스마트스토어센터-로그인-이해>스마트스토어센터 로그인 이해</a><ul><li><a href=#요청-내역-탐색-시-주의사항>요청 내역 탐색 시 주의사항</a></li><li><a href=#네이버-로그인과의-차이점>네이버 로그인과의 차이점</a></li><li><a href=#oauth-url-가져오기>OAuth URL 가져오기</a></li><li><a href=#graphql-로그인-분석>GraphQL 로그인 분석</a></li><li><a href=#2단계-인증-분석>2단계 인증 분석</a></li></ul></li><li><a href=#스마트스토어센터-로그인-구현>스마트스토어센터 로그인 구현</a><ul><li><a href=#네이버-로그인-구현>네이버 로그인 구현</a></li><li><a href=#oauth-로그인-구현>OAuth 로그인 구현</a></li><li><a href=#2단계-인증-구현>2단계 인증 구현</a></li><li><a href=#로그인-메소드-구현>로그인 메소드 구현</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><header class=post-header><div class=post-header-category><a href=/categories/data-engineering/crawling/ class=post-header-category-link>Data Engineering/Crawling</a></div><h1 class=post-header-title>[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (3)</h1><div class=post-header-date><time datetime=2022-12-04T10:22:03+09:00>2022. 12. 4. 10:22</time></div></header><div class=book-cover><img src="https://dl.dropboxusercontent.com/scl/fi/bghhh0kkkr4ssaw5a10ri/smartstore-login-00-main-wide.webp?rlkey=014mj9c15aymkvseohy0dtqih&amp;dl=0" alt="Cover Image" class=book-cover-img></div><p>앞선 네이버 로그인 구현 과정을 통해 네이버 로그인에 대해 이해하고
스마트스토어센터 로그인 결과로 얻을 수 있는 쿠키 값의 일부를 획득했습니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NNB&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;nid_inf&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_AUT&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_SES&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_JKL&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CBI_SES&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CBI_CHK&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NSI&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>하지만, 스마트스토어센터에서 데이터를 가져오기 위해 필요한 쿠키 값은
<code>CBI_SES</code>, <code>CBI_CHK</code>, <code>NSI</code> 세 가지 값이기 때문에
지금까지는 준비 과정에 불과했다고 할 수 있습니다.</p><p>이번 게시글에서는 스마트스토어센터 로그인 과정을 이해하고
직접 구현해보면서 <code>SmartstoreLogin</code> 클래스를 완성해보겠습니다.</p><h2 id=스마트스토어센터-로그인-이해>스마트스토어센터 로그인 이해
<a class=anchor href=#%ec%8a%a4%eb%a7%88%ed%8a%b8%ec%8a%a4%ed%86%a0%ec%96%b4%ec%84%bc%ed%84%b0-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ec%9d%b4%ed%95%b4>#</a></h2><p>지금까지 스마트스토어센터의 두 가지 로그인 방식 중
네이버 로그인 방식으로 로그인을 수행하기 위해,
실제 네이버 로그인에 대한 이해 및 구현을 진행했습니다.</p><h3 id=요청-내역-탐색-시-주의사항>요청 내역 탐색 시 주의사항
<a class=anchor href=#%ec%9a%94%ec%b2%ad-%eb%82%b4%ec%97%ad-%ed%83%90%ec%83%89-%ec%8b%9c-%ec%a3%bc%ec%9d%98%ec%82%ac%ed%95%ad>#</a></h3><p>새 창에서 띄워지는 네이버 로그인 페이지는
로그인이 완료되면 닫혀버리기 때문에 네트워크 요청 내역을 확인하기 어렵습니다.</p><p>이 경우 개발자 도구 Sources 탭에서 Event Listener Breakpoints 메뉴 아래
Window > <code>window.close</code> 부분을 선택하면 창이 닫히는 순간에 중단시킬 수 있습니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/v491onzs75t8n5wypv73d/smartstore-login-12-event-listener.webp?rlkey=ox7z6b80f41g7ewlo386s03k1&amp;dl=0" alt="Sources > Event Listener Breakpoints > Window > window.close"></p><h3 id=네이버-로그인과의-차이점>네이버 로그인과의 차이점
<a class=anchor href=#%eb%84%a4%ec%9d%b4%eb%b2%84-%eb%a1%9c%ea%b7%b8%ec%9d%b8%ea%b3%bc%ec%9d%98-%ec%b0%a8%ec%9d%b4%ec%a0%90>#</a></h3><p>스마트스토어센터 로그인에서의 네이버 로그인은 기존 방식과 다소의 차이점이 존재합니다.</p><p>아래는 스마트스토어센터 로그인 POST 요청에서 확인할 수 있는 데이터입니다.</p><div class=book-codeblock data-lang=json><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">json</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;localechange&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dynamicKey&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;logintp&#34;</span><span class=p>:</span> <span class=s2>&#34;oauth2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;encpw&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;enctp&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;svctype&#34;</span><span class=p>:</span> <span class=mi>64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;smart_LEVEL&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;bvsd&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;uuid&#34;</span><span class=p>:</span><span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;encData&#34;</span><span class=p>:</span><span class=s2>&#34;...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;encnm&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;locale&#34;</span><span class=p>:</span> <span class=s2>&#34;ko_KR&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;client_id&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://nid.naver.com/oauth2.0/authorize?response_type=code&amp;state=...&amp;client_id=...&amp;redirect_uri=https%3A%2F%2Faccounts.commerce.naver.com%2Foauth%2Fcallback&amp;locale=ko_KR&amp;inapp_view=&amp;oauth_os=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;pw&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>기존의 네이버 로그인 데이터와 비교했을 때 3개의 값이 추가되었음을 알 수 있습니다.</p><p><code>logintp</code> 의 경우 <code>"oauth2"</code> 로 고정된 값으로 보이지만,
<code>url</code> 내 <code>state</code> 와 <code>client_id</code> 는 지금까지의 과정에서는 얻을 수 없었던
새로운 값으로 로그인을 위해 추가적인 동작이 필요해 보입니다.</p><h3 id=oauth-url-가져오기>OAuth URL 가져오기
<a class=anchor href=#oauth-url-%ea%b0%80%ec%a0%b8%ec%98%a4%ea%b8%b0>#</a></h3><p><code>state</code> 와 <code>client_id</code> 의 경우 네이버 로그인 페이지를 불러오는 과정에서
이미 전달되는 값이기 때문에 해당 페이지 안에서는 출처를 찾을 수 없었습니다.</p><p>따라서 네이버 로그인 페이지로 이동하기 위해 거치는 스마트스토어센터 로그인 페이지에서
네이버 로그인 페이지를 띄우는 과정에 집중하여 두 값이 발생하는 지점을 찾아보았고,
graphql 주소로 보낸 POST 요청에 대한 응답으로 <code>url</code> 에 해당하는 <code>authUrl</code> 값을 받는 것을 확인했습니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/tfyxyeg8sdjkebyt6fv9k/smartstore-login-13-auth-url.webp?rlkey=hcvmnd2j3o107r38l66pssphd&amp;dl=0" alt="sell.smartstore.naver.com > Response > client_id"></p><p>이렇게 구한 <code>client_id</code> 및 <code>url</code> 값을 로그인 데이터에 담아 요청을 보낼 경우
일반적인 네이버 로그인 결과로 얻을 수 있는 <code>NID_AUT</code> 등의 쿠키 값을 획득할 수 있습니다.</p><h3 id=graphql-로그인-분석>GraphQL 로그인 분석
<a class=anchor href=#graphql-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%eb%b6%84%ec%84%9d>#</a></h3><p>스마트스토어센터 로그인은 네이버 로그인에서 그치지 않고
<code>CBI_SES</code>, <code>CBI_CHK</code>, <code>NSI</code> 쿠키 값을 추가로 얻어야 합니다.</p><p>이 중에서 <code>CBI_SES</code> 를 응답 파일 내에서 검색했을 때 graphql 주소에 대한 응답으로
<code>CBI_SES</code> 와 <code>CBI_CHK</code> 값을 반환하는 것을 알 수 있었습니다.</p><p>해당 주소는 앞서 인증 주소를 가져오는 과정에서 보았던 것인데
당시 <code>snsLoginBegin</code> 라는 명칭의 쿼리와는 다른 <code>snsLoginCallback</code> 쿼리를 사용하여
추가적인 로그인을 수행하는 것임을 짐작할 수 있습니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/8rv6urob0drzyb7kzyxtt/smartstore-login-14-code-state.webp?rlkey=9eixe4xwsx4ec99ifwocgx52a&amp;dl=0" alt="accounts.commerce.naver.com/graphql > Payload > variables"></p><p>변수로 전달되는 <code>state</code> 의 경우 앞에서 구한 것과 동일한 값이지만,
<code>code</code> 는 아직까지 본 적 없는 값입니다.</p><p>하지만, <code>code</code> 는 어떠한 응답 파일 내에서도 출처를 찾아볼 수 없고,
<code>code</code> 의 값 자체를 검색했을 때 <code>oauth_token</code> 이라는 키와 동일한 값을 사용한다는 것 말고는
별다른 단서를 찾을 수 없었습니다.</p><p>이 경우 네이버 로그인 후에 연속적으로 진행되는 다른 요청 내역을 직접 들여다봐야 했고,
다행히 바로 아래의 주소에 대한 응답 내역에서 <code>oauth_token</code> 값을 받아볼 수 있었습니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/oslugg8q683o1t9ue3qb5/smartstore-login-15-oauth-token.webp?rlkey=0kq2firvjjspeprjtpib5p249&amp;dl=0" alt="accounts.commerce.naver.com/authorize > Payload > Query String Parameters"></p><div class=book-codeblock data-lang=html><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">html</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>language</span><span class=o>=</span><span class=s>javascript</span> <span class=na>nonce</span><span class=o>=</span><span class=s>&#34;4SzeR1mCGzDbnzr3s5rjQ1Li&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>location</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;https://nid.naver.com/login/noauth/allow_oauth.nhn?oauth_token=...&amp;with_pin&amp;step=agree_term&amp;inapp_view=&amp;oauth_os=&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div><p><code>oauth_token</code> 의 값을 <code>code</code> 에 넣어서 <code>state</code> 와 함께 graphql 주소에 요청할 경우
응답 헤더의 <code>Set-Cookie</code> 에서 볼 수 있는 <code>CBI_SES</code> 와 <code>CBI_CHK</code> 를 받게 됩니다.</p><h3 id=2단계-인증-분석>2단계 인증 분석
<a class=anchor href=#2%eb%8b%a8%ea%b3%84-%ec%9d%b8%ec%a6%9d-%eb%b6%84%ec%84%9d>#</a></h3><p>스마트스토어센터는 최초 로그인 시 반드시 2단계 인증을 거쳐야 합니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/8wnzlu76st4hadsxi7769/smartstore-login-16-2fa-login.webp?rlkey=9h9dfu3dmr1hc0v7yhlbnlih7&amp;dl=0" alt="스마트스토어센터 2단계 인증"></p><p>마지막 남은 <code>NSI</code> 값 또한 해당 2단계 인증을 거쳐야 얻을 수 있을 것이라 걱정했지만,
다행히 2단계 인증을 거치지 않아도 네트워크 응답 내역에서 <code>NSI</code>를 확인할 수 있었습니다.</p><p><img src="https://dl.dropboxusercontent.com/scl/fi/jq3yg0sfkejwquktcs7kv/smartstore-login-17-2fa-cookies.webp?rlkey=w4t7i7gs09msyaqh56xl9gu4c&amp;dl=0" alt="sell.smartstore.naver.com/api/login > Response Headers > set-cookie: NSI=...;"></p><p>POST 요청이지만 전달되는 데이터는 아래와 같이 단순했기에
추가적인 분석 없이 마지막 <code>NSI</code> 값을 획득했습니다.</p><div class=book-codeblock data-lang=json><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">json</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://sell.smartstore.naver.com/#/home/dashboard&#34;</span><span class=p>}</span></span></span></code></pre></div></div><h2 id=스마트스토어센터-로그인-구현>스마트스토어센터 로그인 구현
<a class=anchor href=#%ec%8a%a4%eb%a7%88%ed%8a%b8%ec%8a%a4%ed%86%a0%ec%96%b4%ec%84%bc%ed%84%b0-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ea%b5%ac%ed%98%84>#</a></h2><p>지금까지의 과정을 통해 스마트스토어센터에서 데이터를 가져오기 위해 필요한
<code>CBI_SES</code>, <code>CBI_CHK</code>, <code>NSI</code> 값을 획득하는 방법을 파악했습니다.</p><p>이를 <code>SmartstoreLogin</code> 클래스의 메소드로 구현해보겠습니다.</p><h3 id=네이버-로그인-구현>네이버 로그인 구현
<a class=anchor href=#%eb%84%a4%ec%9d%b4%eb%b2%84-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ea%b5%ac%ed%98%84>#</a></h3><p>기존의 네이버 로그인 기능에 OAuth URL을 가져오는 부분을 추가시킨
<code>nid_login()</code> 및 <code>fetch_oauth_url()</code> 메소드를 정의합니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>SMARTSTORE_URL</span> <span class=o>=</span> <span class=s2>&#34;https://sell.smartstore.naver.com/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>SLOGIN_URL</span> <span class=o>=</span> <span class=s2>&#34;https://accounts.commerce.naver.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>GRAPHQL_DATA</span> <span class=o>=</span> <span class=nb>str</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;operationName&#34;</span><span class=p>:</span> <span class=s2>&#34;snsLoginBegin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;variables&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;mode&#34;</span><span class=p>:</span> <span class=s2>&#34;login&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;snsCd&#34;</span><span class=p>:</span> <span class=s2>&#34;naver&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;svcUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;https://sell.smartstore.naver.com/#/login-callback&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;mutation snsLoginBegin($mode: String!, $snsCd: String!, $svcUrl: String!, </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>$oneTimeLoginSessionKey: String, $userInfos: [UserInfoEntry!]) {</span><span class=se>\n</span><span class=s2>  snsBegin(</span><span class=se>\n</span><span class=s2>    </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>snsLoginBeginRequest: {mode: $mode, snsCd: $snsCd, svcUrl: $svcUrl, oneTimeLoginSessionKey: </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>$oneTimeLoginSessionKey, userInfos: $userInfos}</span><span class=se>\n</span><span class=s2>  ) {</span><span class=se>\n</span><span class=s2>    authUrl</span><span class=se>\n</span><span class=s2>    __typename</span><span class=se>\n</span><span class=s2>  }</span><span class=se>\n</span><span class=s2>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\&#34;</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_oauth_url</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>referer</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>SLOGIN_URL</span><span class=si>}</span><span class=s2>/login?url=</span><span class=si>{</span><span class=n>SMARTSTORE_URL</span><span class=si>}</span><span class=s2>#/login-callback&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_headers</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>SLOGIN_URL</span><span class=p>,</span> <span class=n>referer</span><span class=o>=</span><span class=n>referer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>urljoin</span><span class=p>(</span><span class=n>SLOGIN_URL</span><span class=p>,</span> <span class=s2>&#34;graphql&#34;</span><span class=p>),</span> <span class=n>data</span><span class=o>=</span><span class=n>GRAPHQL_DATA</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>oauth_url</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;snsBegin&#34;</span><span class=p>][</span><span class=s2>&#34;authUrl&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span><span class=n>v</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span><span class=n>v</span> <span class=ow>in</span> <span class=n>parse_qs</span><span class=p>(</span><span class=n>urlparse</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>oauth_url</span><span class=p>)</span><span class=o>.</span><span class=n>query</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;auth_type&#34;</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;auth_type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=p>,</span> <span class=o>**</span><span class=p>{</span><span class=s2>&#34;locale&#34;</span><span class=p>:</span><span class=s2>&#34;ko_KR&#34;</span><span class=p>,</span><span class=s2>&#34;inapp_view&#34;</span><span class=p>:</span><span class=s1>&#39;&#39;</span><span class=p>,</span><span class=s2>&#34;oauth_os&#34;</span><span class=p>:</span><span class=s1>&#39;&#39;</span><span class=p>})</span></span></span></code></pre></div></div><p>graphql 주소에 대한 요청 데이터를 그대로 구현한 것이 GRAPHQL_DATA이며,
그 결과로 OAuth URL을 얻을 수 있습니다.</p><p>OAuth URL의 파라미터는 향후 GraphQL 인증 과정에서 재활용되기 때문에
<code>oauth_params</code> 변수에 저장해둡니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>LOGIN_URL</span> <span class=o>=</span> <span class=s2>&#34;https://nid.naver.com/nidlogin.login&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SLOGIN_DATA</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>dynamicKey</span><span class=p>,</span> <span class=n>encpw</span><span class=p>,</span> <span class=n>bvsd</span><span class=p>,</span> <span class=n>encnm</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> \
</span></span><span class=line><span class=cl>    <span class=nb>dict</span><span class=p>(</span><span class=n>LOGIN_DATA</span><span class=p>(</span><span class=n>dynamicKey</span><span class=p>,</span> <span class=n>encpw</span><span class=p>,</span> <span class=n>bvsd</span><span class=p>,</span> <span class=n>encnm</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=o>**</span><span class=p>{</span><span class=s2>&#34;logintp&#34;</span><span class=p>:</span><span class=s2>&#34;oauth2&#34;</span><span class=p>,</span><span class=s2>&#34;svctype&#34;</span><span class=p>:</span><span class=s2>&#34;64&#34;</span><span class=p>,</span><span class=s2>&#34;client_id&#34;</span><span class=p>:</span><span class=n>client_id</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>nid_login</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fetch_keys</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>set_encpw</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>set_bvsd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fetch_oauth_url</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>SLOGIN_DATA</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>dynamicKey</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>encpw</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bvsd</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>encnm</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;client_id&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_headers</span><span class=p>(</span><span class=n>LOGIN_URL</span><span class=p>,</span> <span class=n>referer</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>oauth_url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Upgrade-Insecure-Requests&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>LOGIN_URL</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span></span></span></code></pre></div></div><p>네이버 로그인 과정에서는 <code>bvsd</code> 를 생성한 후 OAuth URL을 추가로 가져오고
<code>client_id</code> 를 기존의 로그인 데이터 내에 포함시켜 POST 요청을 보냅니다.</p><p>해당 메소드의 결과로 <code>NID_AUT</code>, <code>NID_JKL</code>, <code>NID_SES</code> 를 부여받을 수 있습니다.</p><h3 id=oauth-로그인-구현>OAuth 로그인 구현
<a class=anchor href=#oauth-%eb%a1%9c%ea%b7%b8%ec%9d%b8-%ea%b5%ac%ed%98%84>#</a></h3><p>OAuth 로그인은 네이버 로그인과 GraphQL 인증으로 구성됩니다.</p><p>현시점에서 GraphQL 인증에 필요한 것은 <code>oauth_token</code> 뿐이기 때문에
앞선 네이버 로그인 과정에서 획득한 주소로부터 <code>oauth_token</code> 을 가져오는 메소드 <code>fetch_oauth_token()</code>과
전체적인 OAuth 로그인 과정을 구현한 <code>oauth_login()</code> 메소드를 정의합니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>OAUTH_URL</span> <span class=o>=</span> <span class=s2>&#34;https://nid.naver.com/oauth2.0/authorize&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch_oauth_token</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_headers</span><span class=p>(</span><span class=n>LOGIN_URL</span><span class=p>,</span> <span class=n>referer</span><span class=o>=</span><span class=n>LOGIN_URL</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_cookies</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>OAUTH_URL</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;(?&lt;=oauth_token\=)(.*?)(?=&amp;)&#34;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>oauth_token</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;(?&lt;=oauth_token\=)(.*?)(?=&amp;)&#34;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>)</span><span class=o>.</span><span class=n>group</span><span class=p>()</span></span></span></code></pre></div></div><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>OAUTH_DATA</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>code</span><span class=p>,</span> <span class=n>state</span><span class=p>:</span> <span class=nb>str</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;operationName&#34;</span><span class=p>:</span><span class=s2>&#34;snsLoginCallback&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;variables&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=n>code</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;state&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;query&#34;</span><span class=p>:</span><span class=s2>&#34;mutation snsLoginCallback($code: String!, $state: String!) </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>{</span><span class=se>\n</span><span class=s2>  snsCallback(snsLoginCallbackRequest: {code: $code, state: $state}) </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>{</span><span class=se>\n</span><span class=s2>    statCd</span><span class=se>\n</span><span class=s2>    loginStatus</span><span class=se>\n</span><span class=s2>    nextUrl</span><span class=se>\n</span><span class=s2>    sessionKey</span><span class=se>\n</span><span class=s2>    snsCd</span><span class=se>\n</span><span class=s2>    </span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=s2>idNo</span><span class=se>\n</span><span class=s2>    realnm</span><span class=se>\n</span><span class=s2>    age</span><span class=se>\n</span><span class=s2>    email</span><span class=se>\n</span><span class=s2>    __typename</span><span class=se>\n</span><span class=s2>  }</span><span class=se>\n</span><span class=s2>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=p>,</span><span class=s1>&#39;</span><span class=se>\&#34;</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>oauth_login</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>nid_login</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fetch_oauth_token</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>code</span><span class=p>,</span> <span class=n>state</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_token</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;state&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>referer</span> <span class=o>=</span> <span class=n>SLOGIN_URL</span><span class=o>+</span><span class=sa>f</span><span class=s2>&#34;/oauth/callback?code=</span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>&amp;state=</span><span class=si>{</span><span class=n>state</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_headers</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>SLOGIN_URL</span><span class=p>,</span> <span class=n>referer</span><span class=o>=</span><span class=n>referer</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_cookies</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>urljoin</span><span class=p>(</span><span class=n>SLOGIN_URL</span><span class=p>,</span> <span class=s2>&#34;graphql&#34;</span><span class=p>),</span> <span class=n>data</span><span class=o>=</span><span class=n>OAUTH_DATA</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=n>state</span><span class=p>),</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=2단계-인증-구현>2단계 인증 구현
<a class=anchor href=#2%eb%8b%a8%ea%b3%84-%ec%9d%b8%ec%a6%9d-%ea%b5%ac%ed%98%84>#</a></h3><p>2단계 인증을 직접 수행할 필요는 없습니다.</p><p><code>NSI</code> 쿠키 값을 할당받을 수 있는 주소로 POST 요청을 보내는
<code>two_factor_login()</code> 메소드를 정의합니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>TWOLOGIN_URL</span> <span class=o>=</span> <span class=n>SMARTSTORE_URL</span><span class=o>+</span><span class=s2>&#34;api/login?url=https%3A</span><span class=si>%2F%2F</span><span class=s2>sell.smartstore.naver.com</span><span class=si>%2F%23%</span><span class=s2>2Fhome</span><span class=si>%2F</span><span class=s2>dashboard&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TWOLOGIN_DATA</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://sell.smartstore.naver.com/#/home/dashboard&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>two_factor_login</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_headers</span><span class=p>(</span><span class=n>SMARTSTORE_URL</span><span class=p>,</span> <span class=n>referer</span><span class=o>=</span><span class=n>SMARTSTORE_URL</span><span class=p>,</span> <span class=n>cookies</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_cookies</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;application/json;charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;x-current-state&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;https://sell.smartstore.naver.com/#/login-callback&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;x-current-statename&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;login-callback&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=p>[</span><span class=s2>&#34;x-to-statename&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;login-callback&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>TWOLOGIN_URL</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>TWOLOGIN_DATA</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=로그인-메소드-구현>로그인 메소드 구현
<a class=anchor href=#%eb%a1%9c%ea%b7%b8%ec%9d%b8-%eb%a9%94%ec%86%8c%eb%93%9c-%ea%b5%ac%ed%98%84>#</a></h3><p><code>SmartstoreLogin</code> 객체를 사용할 때는 <code>login()</code> 메소드를 활용합니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>SmartstoreLogin</span><span class=p>(</span><span class=n>NaverLogin</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>email_pattern</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=s2>&#34;[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>seller_login</span><span class=p>()</span> <span class=k>if</span> <span class=n>email_pattern</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>userid</span><span class=p>)</span> <span class=k>else</span> <span class=bp>self</span><span class=o>.</span><span class=n>oauth_login</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>two_factor_login</span><span class=p>()</span></span></span></code></pre></div></div><p>향후 판매자 계정으로 로그인 하는 경우를 고려해
<code>userid</code>가 이메일인 경우 <code>seller_login()</code> 이라는 미구현된 메소드를 실행하도록 정의했습니다.</p><p>일반적인 네이버 아이디를 사용할 경우엔 OAuth 로그인과 2단계 인증을 거쳐
처음 목적으로 했던 아래의 모든 쿠키 값을 획득하게 됩니다.</p><div class=book-codeblock data-lang=python><div class=code-actions><button class="code-copy-btn code-action" onclick=copyCode(this)>
<i class="fa-solid fa-copy"></i>Copy
</button>
<span class="code-language code-action">python</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cookies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NNB&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;nid_inf&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_AUT&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_SES&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NID_JKL&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CBI_SES&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CBI_CHK&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;NSI&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>해당 쿠키를 가진 <code>SmartstoreLogin</code> 객체를 세션 객체로 활용한다면
스마트스토어센터 내 어떤 데이터라도 파이썬 <code>requests</code> 모듈로 가져올 수 있게 됩니다.</p></article><div class=book-nav><button class=book-nav-btn3 onclick='window.scrollTo({top:0,behavior:"smooth"})' title="Go to top">
<i class="fa fa-chevron-up"></i>
</button>
<button class=book-nav-btn3 onclick='window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})' title="Go to bottom">
<i class="fa fa-chevron-down"></i>
<button class=book-nav-btn3 onclick=history.back() title="Go back">
<i class="fa-solid fa-arrow-left"></i></button></div><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class=post-tags><a href=/tags/%ED%81%AC%EB%A1%A4%EB%A7%81/ class=tag>#크롤링</a>
<a href=/tags/python/ class=tag>#Python</a>
<a href=/tags/%EB%84%A4%EC%9D%B4%EB%B2%84/ class=tag>#네이버</a>
<a href=/tags/%EC%8A%A4%EB%A7%88%ED%8A%B8%EC%8A%A4%ED%86%A0%EC%96%B4/ class=tag>#스마트스토어</a>
<a href=/tags/oauth-%EC%9D%B8%EC%A6%9D/ class=tag>#OAuth 인증</a>
<a href=/tags/graphql/ class=tag>#GraphQL</a>
<a href=/tags/2%EB%8B%A8%EA%B3%84-%EC%9D%B8%EC%A6%9D/ class=tag>#2단계 인증</a>
<a href=/tags/requests/ class=tag>#requests</a>
<a href=/tags/%EC%BF%A0%ED%82%A4-%EC%9D%B8%EC%A6%9D/ class=tag>#쿠키 인증</a>
<a href=/tags/%EC%9B%B9-%EC%9E%90%EB%8F%99%ED%99%94/ class=tag>#웹 자동화</a></div><div class=post-navigation><a href=/blog/smartstore-login-2/ class="post-nav-link post-nav-prev"><span class=post-nav-direction><i class="fa-solid fa-backward"></i> PREV</span>
<span class=post-nav-title>[Python] requests로 네이버 스마트스토어센터 로그인 구현하기 (2)</span>
</a><a href=/blog/10000-recipe/ class="post-nav-link post-nav-next"><span class=post-nav-direction>NEXT <i class="fa-solid fa-forward"></i></span>
<span class=post-nav-title>[Python] 만개의 레시피 크롤링 - BeautifulSoup, requests로 레시피·평점·댓글 수집</span></a></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=book-comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://minyeamer.github.io/blog/smartstore-login-3/",this.page.identifier="https://minyeamer.github.io/blog/smartstore-login-3/"};(function(){var e=document,t=e.createElement("script");t.src="https://minyeamer.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})();function reloadDisqus(){window.DISQUS&&DISQUS.reset({reload:!0,config:function(){this.page.url="https://minyeamer.github.io/blog/smartstore-login-3/",this.page.identifier="https://minyeamer.github.io/blog/smartstore-login-3/"}})}</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#스마트스토어센터-로그인-이해>스마트스토어센터 로그인 이해</a><ul><li><a href=#요청-내역-탐색-시-주의사항>요청 내역 탐색 시 주의사항</a></li><li><a href=#네이버-로그인과의-차이점>네이버 로그인과의 차이점</a></li><li><a href=#oauth-url-가져오기>OAuth URL 가져오기</a></li><li><a href=#graphql-로그인-분석>GraphQL 로그인 분석</a></li><li><a href=#2단계-인증-분석>2단계 인증 분석</a></li></ul></li><li><a href=#스마트스토어센터-로그인-구현>스마트스토어센터 로그인 구현</a><ul><li><a href=#네이버-로그인-구현>네이버 로그인 구현</a></li><li><a href=#oauth-로그인-구현>OAuth 로그인 구현</a></li><li><a href=#2단계-인증-구현>2단계 인증 구현</a></li><li><a href=#로그인-메소드-구현>로그인 메소드 구현</a></li></ul></li></ul></nav></div></aside></main></body></html>