document.addEventListener("DOMContentLoaded",function(){if(!window.location.pathname.startsWith("/search/"))return;const t=new URLSearchParams(window.location.search),e={query:t.get("query")||"",category1:(t.get("category1")||"").toLowerCase(),category2:(t.get("category2")||"").toLowerCase(),tags:t.get("tags")?t.get("tags").split(",").map(e=>e.trim().toLowerCase()).filter(e=>e):[],tagsOp:t.get("tagsOp")||"and",page:Math.max(1,parseInt(t.get("page"))||1),pageSize:Math.max(1,parseInt(t.get("pageSize"))||10)},v=document.querySelector("#search-data"),i=document.querySelector("#search-results"),u=document.querySelector("#search-no-results");switch(h(e)){case"search":window.siteSearch.initIndex().then(()=>{const t=f(e,!0);s(t,e)});break;case"category1":window.siteSearch.initCategories().then(()=>{const t=l(e,!0);s(t,e)});break;case"category2":window.siteSearch.initCategories().then(()=>{const t=d(e,!0);s(t,e)});break;case"tags":window.siteSearch.initTags().then(()=>{const t=r(e,!0);s(t,e)});break;case"combined":Promise.all([window.siteSearch.initIndex(),window.siteSearch.initCategories(),window.siteSearch.initTags()]).then(()=>{const t=p(e,!0);s(t,e)});break;default:window.siteSearch.initIndex().then(()=>{n(),o("검색 결과","fa-magnifying-glass",0,""),s(new Set)});break}function h(e){const s=e.query.length>0,t=e.category1.length>0,o=e.category2.length>0,n=e.tags.length>0;return s?t|n?"combined":"search":t?o?"category2":"category1":n?"tags":"none"}function j(e){return e?encodeURIComponent(e.toLowerCase()).replace(/[!'()*~]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}):""}function c(e){return e?e.split(" ").map(e=>e?e.charAt(0).toUpperCase()+e.slice(1):"").join(" "):""}function n(){const t=document.querySelector("#list-header");t.replaceChildren();const e=document.querySelector("#taxonomy-section");e.classList.contains("hidden")&&(e.classList.add("hidden"),e.replaceChildren())}function o(e,t,n,s=""){const o=document.createDocumentFragment(),c=document.querySelector("#list-header"),a=document.createElement("h1");a.innerHTML=`<i class="fa-solid ${t}"></i> ${e}`,o.appendChild(a);const i=document.createElement("p"),r=`<em class="list-count">${n}</em>`;if(s){const e='"%q" 검색 결과 %s'.replace("%q",s);i.innerHTML=e.replace("%s",r)}else i.innerHTML="전체 글 %s".replace("%s",r);o.appendChild(i),c.appendChild(o)}function a(e,t){const n=document.createDocumentFragment(),o=document.querySelector("#taxonomy-section");o.classList.remove("hidden");const i=document.createElement("h2");i.textContent=e,n.appendChild(i);const s=document.createElement("div");s.className="taxonomy-chips",t.forEach(e=>{const t=m(e);s.appendChild(t)}),n.appendChild(s),o.appendChild(n)}function m({text:e,icon:t,href:n,pageCount:s}){const i=document.createElement("div");i.className="taxonomy-chip";const o=document.createElement("a");o.href=n,o.className="taxonomy-link";const a=document.createElement("span"),r=`<span class="taxonomy-count">(${s})</span>`;return a.className="taxonomy-name",a.innerHTML=`<i class="fa-solid ${t}"></i> ${e} ${r}`,o.appendChild(a),i.appendChild(o),i}function f(e,t=!1){const i=window.siteSearch.index.search(e.query),s=new Set(i.map(e=>e.item.id));return t&&(n(),o("검색 결과","fa-magnifying-glass",s.size,e.query)),s}function l(e,t=!1){const s=window.siteSearch.categories[e.category1],i=s instanceof Object&&Object.keys(s).length>0,r=i?s.A.name:c(e.category1),l=i?s.A.ids:[];if(t){n(),o(r,"fa-folder",l.length);const e=Object.keys(s).toSorted().filter(e=>e!=="A"&&s[e]instanceof Object).map(e=>({text:s[e].name,icon:"fa-file",href:`/search/?category1=${r}&category2=${s[e].name}`,pageCount:s[e].ids.length}));e.length>0&&a("하위 카테고리",e)}return new Set(l)}function d(e,t=!1){const s=window.siteSearch.categories[e.category1],r=s instanceof Object&&Object.keys(s).length>0,l=r?s.A.name:"",i=r?s[e.category2]:null,d=r&&i instanceof Object&&Object.keys(i).length>0,h=d?i.name:c(e.category2),u=d?i.ids:[];return t&&(n(),o(h,"fa-file",u.length),l&&(taxonomy={text:l,icon:"fa-folder-open",href:`/search/?category1=${l}`,pageCount:s.A.ids.length},a("상위 카테고리",[taxonomy]))),new Set(u)}function r(e,t=!1){const r=window.siteSearch.tags,c=e.tagsOp==="or",i=new Array;let s=new Set;if(e.tags.forEach((e,t)=>{const n=r[e];if(n instanceof Object){i.push(n.name);const e=new Set(n.ids);c?e.forEach(e=>s.add(e)):t===0?s=e:s=new Set([...s].filter(t=>e.has(t)))}}),t){n();const e=i.length===1,t=e?i[0]:"검색 결과",c=e?"fa-tag":"fa-tags";if(o(t,c,s.size),!e){const e=i.toSorted().map(e=>({text:e,icon:"fa-tag",href:`/search/?tags=${e}`,pageCount:r[e.toLowerCase()].ids.length}));e.length>0&&a("검색 태그",e)}}return s}function p(e,t=!1){const i=window.siteSearch.index.search(e.query);let s=new Set(i.map(e=>e.item.id));if(s.size>0&&e.category1)if(e.category2){const t=d(e,!1);s=new Set([...s].filter(e=>t.has(e)))}else{const t=l(e,!1);s=new Set([...s].filter(e=>t.has(e)))}if(s.size>0&&e.tags.length>0){const t=r(e,!1);s=new Set([...s].filter(e=>t.has(e)))}return t&&(n(),o("검색 결과","fa-magnifying-glass",s.size,e.query)),s}function g(){i.replaceChildren(),i.classList.add("hidden"),u.classList.remove("hidden")}function s(e,n){g();const o=e.size;if(o===0)return;const a=document.createDocumentFragment(),c=Array.from(e).toSorted((e,t)=>e-t),l=v.querySelectorAll(".search-item"),s=Math.ceil(o/n.pageSize);if(n.page>s){const e=new URLSearchParams(t);e.set("page",s),window.location.href=`${window.location.pathname}?${e.toString()}#pagination-anchor`;return}const r=(n.page-1)*n.pageSize,d=Math.min(r+n.pageSize,o);for(let e=r;e<d;e++){const t=c[e];a.appendChild(l[t].cloneNode(!0))}if(u.classList.add("hidden"),i.classList.remove("hidden"),i.appendChild(a),s>1){const o=Math.floor((n.page-1)/10),e=o*10+1,t=Math.min(e+9,s),i=Array.from({length:t-e+1},(t,n)=>e+n),a=e>1?e-1:null,r=t<s?t+1:null;b({cur:n.page,prev:a,next:r,pages:i})}else{const e=document.querySelector("#pagination");e&&e.classList.add("hidden")}}function b({cur:e,pages:n,prev:s=null,next:o=null}){const a=document.querySelector("#pagination");if(!a)return;const i=document.createDocumentFragment(),r=e=>{const n=new URLSearchParams(t);return n.set("page",e),`/search/?${n.toString()}#pagination-anchor`};(function(){if(s!==null){const e=document.createElement("a");e.href=r(s),e.classList.add("pagination-nav","pagination-link"),e.innerHTML=`<i class="fa-solid fa-backward"></i> 이전`,i.appendChild(e)}else{const e=document.createElement("span");e.classList.add("pagination-nav","disabled"),e.innerHTML=`<i class="fa-solid fa-backward"></i> 이전`,i.appendChild(e)}})(),function(){const s=document.createElement("div");s.classList.add("pagination-pages"),n.forEach(t=>{if(t===e){const e=document.createElement("span");e.classList.add("pagination-page","current"),e.id="current-page",e.textContent=t,s.appendChild(e)}else{const e=document.createElement("a");e.href=r(t),e.classList.add("pagination-page","pagination-link"),e.textContent=t,s.appendChild(e)}}),i.appendChild(s)}(),function(){if(o!==null){const e=document.createElement("a");e.href=r(o),e.classList.add("pagination-nav","pagination-link"),e.innerHTML=`다음 <i class="fa-solid fa-forward"></i>`,i.appendChild(e)}else{const e=document.createElement("span");e.classList.add("pagination-nav","disabled"),e.innerHTML=`다음 <i class="fa-solid fa-forward"></i>`,i.appendChild(e)}}(),a.replaceChildren(i),a.classList.remove("hidden")}})