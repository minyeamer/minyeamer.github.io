document.addEventListener("DOMContentLoaded",function(){if(!window.location.pathname.startsWith("/search/"))return;const s=new URLSearchParams(window.location.search),t={query:s.get("query")||"",category1:s.get("category1")||"",category2:s.get("category2")||"",tags:s.get("tags")?[...new Set(s.get("tags").split(",").map(e=>e.trim()).filter(e=>e))]:[],tagsOp:s.get("tagsOp")||"and",page:Math.max(1,parseInt(s.get("page"))||1),pageSize:Math.max(1,parseInt(s.get("pageSize"))||10)},C=A(t),d="search-filter-expanded",n={SEARCH:"검색",SEARCH_PLACEHOLDER:"검색어를 입력해주세요",SEARCH_RESULTS:"검색 결과",SEARCH_LABEL:'"%q" 검색 결과 %s',SEARCH_TAGS:"검색 태그",LIST_LABEL:"전체 글 %s",CATEGORY_PARENT:"상위 카테고리",CATEGORY_CHILD:"하위 카테고리",TAGS:"태그",TAGS_OP_ALL:"모두 일치",ADVANCED_FILTERS:"고급 필터",PREV_PAGE:"이전",NEXT_PAGE:"다음"};function e(e,t={}){const n=document.createElement(e);return t.text&&(n.textContent=t.text),t.html&&(n.innerHTML=t.html),t.className&&(n.className=t.className),t.id&&(n.id=t.id),t.attrs&&Object.entries(t.attrs).forEach(([e,t])=>{n.setAttribute(e,t)}),t.dataset&&Object.entries(t.dataset).forEach(([e,t])=>{n.dataset[e]=t}),t.styles&&Object.entries(t.styles).forEach(([e,t])=>{n.style[e]=t}),n}const I=document.querySelector("#search-data"),l=document.querySelector("#search-results"),w=document.querySelector("#search-no-results"),h=document.querySelector("#list-header");switch(C){case"search":Promise.all([window.siteSearch.initIndex(),window.siteSearch.initCategories(),window.siteSearch.initTags()]).then(()=>{const e=D(t,!0);a(e,t)});break;case"category1":window.siteSearch.initCategories().then(()=>{const e=_(t,!0);a(e,t)});break;case"category2":window.siteSearch.initCategories().then(()=>{const e=y(t,!0);a(e,t)});break;case"tags":window.siteSearch.initTags().then(()=>{const e=g(t,!0);a(e,t)});break;case"combined":Promise.all([window.siteSearch.initIndex(),window.siteSearch.initCategories(),window.siteSearch.initTags()]).then(()=>{const e=P(t,!0);a(e,t)});break;default:Promise.all([window.siteSearch.initIndex(),window.siteSearch.initCategories(),window.siteSearch.initTags()]).then(()=>{c(),r(n.SEARCH_RESULTS,"fa-file-lines",0,""),a(new Set)});break}function A(e){const s=e.query.length>0,t=e.category1.length>0,o=e.category2.length>0,n=e.tags.length>0;return s?t|n?"combined":"search":t?o?"category2":"category1":n?"tags":"none"}function x(e){return e?e.split(" ").map(e=>e?e.charAt(0).toUpperCase()+e.slice(1):"").join(" "):""}function u(e=!1){const n=new URLSearchParams,s=document.querySelector("#search-query-input");if(s&&s.value.trim()&&n.set("query",s.value.trim()),e)t.category1&&n.set("category1",t.category1),t.category2&&n.set("category2",t.category2),t.tags.length>0&&(n.set("tags",t.tags.join(",")),n.set("tagsOp",t.tagsOp));else{const s=document.querySelector("#filter-category1-chips"),t=s?.querySelector(".search-filter-chip");if(t){n.set("category1",t.dataset.name);const s=document.querySelector("#filter-category2-chips"),e=s?.querySelector(".search-filter-chip");e&&n.set("category2",e.dataset.name)}const o=document.querySelector("#filter-tags-chips"),e=o?.querySelectorAll(".search-filter-chip");if(e&&e.length>0){const s=Array.from(e).map(e=>e.dataset.name);n.set("tags",s.join(","));const t=document.querySelector("#filter-tagsOp");t&&n.set("tagsOp",t.checked?"and":"or")}}return`/search/?${n.toString()}`}function c(){h.replaceChildren();const e=document.querySelector("#taxonomy-section");e.classList.contains("hidden")&&(e.classList.add("hidden"),e.replaceChildren())}function r(t,s,o,i=""){const a=document.createDocumentFragment(),l=e("h1",{html:`<i class="fa-solid ${s}"></i> ${t}`}),c=`<em class="list-count">${o}</em>`;let r;if(i){const e=n.SEARCH_LABEL.replace("%q",i);r=e.replace("%s",c)}else r=n.LIST_LABEL.replace("%s",c);a.appendChild(l),a.appendChild(e("p",{html:r})),h.appendChild(a)}function m(t,n){const s=document.createDocumentFragment(),o=document.querySelector("#taxonomy-section");o.classList.remove("hidden");const a=e("h2",{text:t}),i=e("div",{className:"taxonomy-chips"});n.forEach(e=>{i.appendChild(R(e))}),s.appendChild(a),s.appendChild(i),o.appendChild(s)}function R({text:t,icon:n,href:s,pageCount:o}){const i=e("div",{className:"taxonomy-chip"}),a=e("a",{className:"taxonomy-link",attrs:{href:s}}),r=`<span class="taxonomy-count">(${o})</span>`;return a.appendChild(e("span",{className:"taxonomy-name",html:`<i class="fa-solid ${n}"></i> ${t} ${r}`})),i.appendChild(a),i}function v({hasAdvancedFilter:t=!1,queryValue:s=""}={}){const i=e("div",{className:"search-query-row"}),o=e("div",{className:"query-input-wrapper"}),a=e("i",{className:"fa-solid fa-magnifying-glass search-query-icon"});o.appendChild(a);const r=e("input",{id:"search-query-input",className:"search-query-input",attrs:{type:"text",placeholder:n.SEARCH_PLACEHOLDER,autocomplete:"off",value:s}});o.appendChild(r);const c=e("button",{className:"search-query-button",text:n.SEARCH,attrs:{type:"button"}});if(o.appendChild(c),i.appendChild(o),t){const t=e("button",{className:"search-filter-toggle",html:`<i class="fa-solid fa-caret-up"></i> ${n.ADVANCED_FILTERS}`,attrs:{type:"button"}});i.appendChild(t)}return i}function b(e=!1){const n=document.querySelector("#search-query-input"),s=document.querySelector(".search-query-button"),t=()=>{const t=u(e);t.includes("query=")&&(window.location.href=t)};n.addEventListener("keydown",function(e){e.key==="Enter"&&(e.preventDefault(),t())}),s.addEventListener("click",t)}function j(t,s=!1){const c=t==="category2",a=c?n.CATEGORY_CHILD:n.CATEGORY_PARENT,o=e("div",{className:"taxonomy-filter"});o.appendChild(e("label",{text:a,attrs:{for:`filter-${t}`}}));const i=e("div",{className:"taxonomy-input-wrapper"}),r=e("input",{id:`filter-${t}`,className:"search-filter-input",attrs:{type:"text",placeholder:a,autocomplete:"off"}});s&&(r.disabled=!0),i.appendChild(r);const l=e("div",{id:`filter-${t}-dropdown`,className:"search-filter-dropdown hidden"});i.appendChild(l),o.appendChild(i);const d=e("div",{id:`filter-${t}-chips`,className:"search-filter-chips"});return o.appendChild(d),o}function L(){const t=e("div",{className:"taxonomy-filter taxonomy-filter-wide"});t.appendChild(e("label",{text:n.TAGS,attrs:{for:"filter-tags"}}));const s=e("div",{className:"taxonomy-input-wrapper"}),o=e("input",{id:"filter-tags",className:"search-filter-input",attrs:{type:"text",placeholder:n.TAGS,autocomplete:"off"}});s.appendChild(o);const i=e("div",{id:"filter-tags-dropdown",className:"search-filter-dropdown hidden"});s.appendChild(i),t.appendChild(s);const a=e("div",{id:"filter-tags-chips",className:"search-filter-chips search-filter-chips-wrap"});return t.appendChild(a),t}function N(){const o=e("div",{className:"taxonomy-filter tags-op-checkbox"}),s=e("label",{className:"tags-op-label"}),i=e("input",{id:"filter-tagsOp",attrs:{type:"checkbox"}});return i.checked=t.tagsOp==="and",s.appendChild(i),s.appendChild(e("span",{text:n.TAGS_OP_ALL})),o.appendChild(s),o}function f(){const t=document.createDocumentFragment(),n=e("div",{className:"search-filter"}),s=v({hasAdvancedFilter:!1,queryValue:""});n.appendChild(s),t.appendChild(n),h.appendChild(t),b(!0)}function O(n){const r=document.createDocumentFragment(),o=e("div",{className:"search-filter"}),c=v({hasAdvancedFilter:!0,queryValue:t.query});o.appendChild(c);const s=e("div",{className:"search-taxonomies-row"});t.category1||t.category2||t.tags&&t.tags.length>0||s.classList.add("hidden");const i=e("div",{className:"search-categories-filter"});i.appendChild(j("category1")),i.appendChild(j("category2",!0)),s.appendChild(i);const a=e("div",{className:"search-tags-filter"});a.appendChild(L()),a.appendChild(N()),s.appendChild(a),o.appendChild(s),r.appendChild(o),h.appendChild(r),b(!1),T(),M(n),S()}function T(){const e=document.querySelector(".search-filter-toggle"),t=document.querySelector(".search-taxonomies-row"),n=C==="combined",s=localStorage.getItem(d);(n||s==="true")&&(t.classList.remove("hidden"),e.classList.add("expanded"),localStorage.setItem(d,"true")),e.addEventListener("click",function(){const n=t.classList.contains("hidden");n?(t.classList.remove("hidden"),e.classList.add("expanded"),localStorage.setItem(d,"true")):(t.classList.add("hidden"),e.classList.remove("expanded"),localStorage.setItem(d,"false"))})}function M(e){const r=document.querySelector("#filter-category1"),s=document.querySelector("#filter-category1-dropdown"),c=document.querySelector("#filter-category2"),i=document.querySelector("#filter-category2-dropdown"),l=document.querySelector("#filter-tags"),a=document.querySelector("#filter-tags-dropdown");let t=-1,n=null;r.addEventListener("input",function(){const a=this.value.trim().toLowerCase(),i=k(a,e);i.length>0?(o(s,i,"category1"),s.classList.remove("hidden"),n=s,t=-1):(s.classList.add("hidden"),n=null,t=-1)}),r.addEventListener("focus",function(){i.classList.add("hidden"),a.classList.add("hidden");const r=this.value.trim().toLowerCase(),t=k(r,e);t.length>0&&(o(s,t,"category1"),s.classList.remove("hidden"),n=s)}),c.addEventListener("input",function(){const a=this.value.trim().toLowerCase(),s=p(a,e);s.length>0?(o(i,s,"category2"),i.classList.remove("hidden"),n=i,t=-1):(i.classList.add("hidden"),n=null,t=-1)}),c.addEventListener("focus",function(){if(this.disabled)return;s.classList.add("hidden"),a.classList.add("hidden");const r=this.value.trim().toLowerCase(),t=p(r,e);t.length>0&&(o(i,t,"category2"),i.classList.remove("hidden"),n=i)}),l.addEventListener("input",function(){const i=this.value.trim().toLowerCase(),s=E(i,e);s.length>0?(o(a,s,"tags"),a.classList.remove("hidden"),n=a,t=-1):(a.classList.add("hidden"),n=null,t=-1)}),l.addEventListener("focus",function(){s.classList.add("hidden"),i.classList.add("hidden");const r=this.value.trim().toLowerCase(),t=E(r,e);t.length>0&&(o(a,t,"tags"),a.classList.remove("hidden"),n=a)}),[r,c,l].forEach(e=>{e.addEventListener("keydown",function(e){if(!n||n.classList.contains("hidden"))return;const s=n.querySelectorAll(".search-filter-dropdown-item");if(s.length===0)return;switch(e.key){case"ArrowDown":e.preventDefault(),t=(t+1)%s.length,d(s,t);break;case"ArrowUp":e.preventDefault(),t=(t-1+s.length)%s.length,d(s,t);break;case"Enter":e.preventDefault(),s.length>0&&(t>=0&&t<s.length?s[t].click():s[0].click());break;case"Escape":e.preventDefault(),n.classList.add("hidden"),n=null,t=-1;break}})}),document.addEventListener("click",function(e){e.target.closest(".taxonomy-filter")||([s,i,a].forEach(e=>{e.classList.add("hidden")}),n=null,t=-1)});const h=document.querySelector("#filter-tagsOp");h.addEventListener("change",function(){const t=document.querySelector("#filter-tags-chips"),e=t?.querySelectorAll(".search-filter-chip");e&&e.length>0&&(window.location.href=u())});function d(e,t){e.forEach((e,n)=>{n===t?(e.classList.add("active"),e.scrollIntoView({block:"nearest"})):e.classList.remove("active")})}}function S(){const e=window.siteSearch.categories,n=window.siteSearch.tags;if(t.category1){const n=e[t.category1.toLowerCase()];if(n&&n.A){const e=document.querySelector("#filter-category1-chips"),s=i(n.A.name,t.category1,"category1");e.appendChild(s);const o=document.querySelector("#filter-category2");if(o.disabled=!1,t.category2){const e=n[t.category2.toLowerCase()];if(e){const n=document.querySelector("#filter-category2-chips"),s=i(e.name,t.category2,"category2");n.appendChild(s)}}}}if(t.tags&&t.tags.length>0){const e=document.querySelector("#filter-tags-chips");t.tags.forEach(t=>{const s=n[t.toLowerCase()];if(s){const n=i(s.name,t,"tags");e.appendChild(n)}})}}function k(e,t){const n=window.siteSearch.categories,s=[];for(const i in n){const o=n[i];if(o.A&&o.A.name){const n=o.A.name,r=new Set(o.A.ids),a=[...t].filter(e=>r.has(e)).length;a>0&&n.toLowerCase().includes(e)&&s.push({name:n,count:a,key:i})}}return s.sort((e,t)=>e.name.localeCompare(t.name))}function p(e,t){const i=document.querySelector("#filter-category1-chips"),s=i?.querySelector(".search-filter-chip");if(!s)return[];const a=s.dataset.key.toLowerCase(),r=window.siteSearch.categories,n=r[a];if(!n)return[];const o=[];for(const i in n){if(i==="A")continue;const s=n[i];if(s&&s.name){const n=s.name,r=new Set(s.ids),a=[...t].filter(e=>r.has(e)).length;a>0&&n.toLowerCase().includes(e)&&o.push({name:n,count:a,key:i})}}return o.sort((e,t)=>e.name.localeCompare(t.name))}function E(e,n){const s=window.siteSearch.tags,o=[],i=new Set(t.tags.map(e=>e.toLowerCase()));for(const a in s){if(i.has(a.toLowerCase()))continue;const t=s[a];if(t&&t.name){const s=t.name,r=new Set(t.ids),i=[...n].filter(e=>r.has(e)).length;i>0&&s.toLowerCase().includes(e)&&o.push({name:s,count:i,key:a})}}return o.sort((e,t)=>e.name.localeCompare(t.name))}function o(t,n,s){t.replaceChildren();const o=document.createDocumentFragment();n.forEach(t=>{const n=e("div",{className:"search-filter-dropdown-item",dataset:{key:t.key,name:t.name}});n.appendChild(e("span",{className:"dropdown-item-name",text:t.name})),n.appendChild(e("span",{className:"dropdown-item-count",text:`(${t.count})`})),n.addEventListener("click",function(){F(s,t)}),o.appendChild(n)}),t.appendChild(o)}function F(e,t){const s=document.querySelector(`#filter-${e}-dropdown`),o=document.querySelector(`#filter-${e}`),n=document.querySelector(`#filter-${e}-chips`);if(s.classList.add("hidden"),o.value="",e==="category1"){n.replaceChildren();const s=i(t.name,t.key,e);n.appendChild(s);const o=document.querySelector("#filter-category2");o.disabled=!1;const a=document.querySelector("#filter-category2-chips");a.replaceChildren()}else if(e==="category2"){n.replaceChildren();const s=i(t.name,t.key,e);n.appendChild(s)}else if(e==="tags"){const s=n.querySelectorAll(".search-filter-chip");for(const e of s)if(e.dataset.key===t.key)return;const o=i(t.name,t.key,e);n.appendChild(o)}window.location.href=u()}function i(t,n,s){const o=e("div",{className:"search-filter-chip",dataset:{key:n,name:t},styles:{cursor:"pointer"}});return o.appendChild(e("span",{className:"chip-name",text:t})),o.appendChild(e("button",{className:"chip-remove",html:"&times;"})),o.addEventListener("click",function(){z(s,o)}),o}function z(e,t){if(t.remove(),e==="category1"){const e=document.querySelector("#filter-category2");e.disabled=!0,e.value="";const t=document.querySelector("#filter-category2-chips");t.replaceChildren();const n=document.querySelector("#filter-category2-dropdown");n.classList.add("hidden")}window.location.href=u()}function D(e,t=!1){const o=window.siteSearch.index.search(e.query),s=new Set(o.map(e=>e.item.id));return t&&(c(),r(n.SEARCH_RESULTS,"fa-file-lines",s.size,e.query),O(s)),s}function _(e,t=!1){const s=window.siteSearch.categories[e.category1.toLowerCase()],o=s instanceof Object&&Object.keys(s).length>0,i=o?s.A.name:x(e.category1),a=o?s.A.ids:[];if(t){c(),r(i,"fa-folder",a.length),f();const e=Object.keys(s).toSorted().filter(e=>e!=="A"&&s[e]instanceof Object).map(e=>({text:s[e].name,icon:"fa-file",href:`/search/?category1=${i}&category2=${s[e].name}`,pageCount:s[e].ids.length}));e.length>0&&m(n.CATEGORY_CHILD,e)}return new Set(a)}function y(e,t=!1){const s=window.siteSearch.categories[e.category1.toLowerCase()],i=s instanceof Object&&Object.keys(s).length>0,a=i?s.A.name:"",o=i?s[e.category2.toLowerCase()]:null,l=i&&o instanceof Object&&Object.keys(o).length>0,u=l?o.name:x(e.category2),d=l?o.ids:[];return t&&(c(),r(u,"fa-file",d.length),f(),a&&(taxonomy={text:a,icon:"fa-folder-open",href:`/search/?category1=${a}`,pageCount:s.A.ids.length},m(n.CATEGORY_PARENT,[taxonomy]))),new Set(d)}function g(e,t=!1){const i=window.siteSearch.tags,a=e.tagsOp==="or",o=new Array;let s=new Set;if(e.tags.forEach((e,t)=>{const n=i[e.toLowerCase()];if(n instanceof Object){o.push(n.name);const e=new Set(n.ids);a?e.forEach(e=>s.add(e)):t===0?s=e:s=new Set([...s].filter(t=>e.has(t)))}}),t){c();const e=o.length===1,t=e?o[0]:n.SEARCH_RESULTS,a=e?"fa-tag":"fa-tags";if(r(t,a,s.size),f(),!e){const e=o.toSorted().map(e=>({text:e,icon:"fa-tag",href:`/search/?tags=${e}`,pageCount:i[e.toLowerCase()].ids.length}));e.length>0&&m(n.SEARCH_TAGS,e)}}return s}function P(e,t=!1){const o=window.siteSearch.index.search(e.query);let s=new Set(o.map(e=>e.item.id));if(s.size>0&&e.category1)if(e.category2){const t=y(e,!1);s=new Set([...s].filter(e=>t.has(e)))}else{const t=_(e,!1);s=new Set([...s].filter(e=>t.has(e)))}if(s.size>0&&e.tags.length>0){const t=g(e,!1);s=new Set([...s].filter(e=>t.has(e)))}return t&&(c(),r(n.SEARCH_RESULTS,"fa-file-lines",s.size,e.query),O(s)),s}function H(){l.replaceChildren(),l.classList.add("hidden"),w.classList.remove("hidden")}function a(e,t){H();const o=e.size;if(o===0)return;const i=document.createDocumentFragment(),r=Array.from(e).toSorted((e,t)=>e-t),c=I.querySelectorAll(".search-item"),n=Math.ceil(o/t.pageSize);if(t.page>n){const e=new URLSearchParams(s);e.set("page",n),window.location.href=`${window.location.pathname}?${e.toString()}#pagination-anchor`;return}const a=(t.page-1)*t.pageSize,d=Math.min(a+t.pageSize,o);for(let e=a;e<d;e++){const t=r[e];i.appendChild(c[t].cloneNode(!0))}if(w.classList.add("hidden"),l.classList.remove("hidden"),l.appendChild(i),n>1){const o=Math.floor((t.page-1)/10),e=o*10+1,s=Math.min(e+9,n),i=Array.from({length:s-e+1},(t,n)=>e+n),a=e>1?e-1:null,r=s<n?s+1:null;B({cur:t.page,prev:a,next:r,pages:i})}else{const e=document.querySelector("#pagination");e&&e.classList.add("hidden")}}function B({cur:t,pages:o,prev:i=null,next:a=null}){const c=document.querySelector("#pagination");if(!c)return;const r=document.createDocumentFragment(),l=e=>{const t=new URLSearchParams(s);return t.set("page",e),`/search/?${t.toString()}#pagination-anchor`};(function(){i!==null?r.appendChild(e("a",{className:"pagination-nav pagination-link",html:`<i class="fa-solid fa-backward"></i> ${n.PREV_PAGE}`,attrs:{href:l(i)}})):r.appendChild(e("span",{className:"pagination-nav disabled",html:`<i class="fa-solid fa-backward"></i> ${n.PREV_PAGE}`}))})(),function(){const s=e("div",{className:"pagination-pages"});o.forEach(n=>{n===t?s.appendChild(e("span",{id:"current-page",className:"pagination-page current",text:n.toString()})):s.appendChild(e("a",{className:"pagination-page pagination-link",text:n.toString(),attrs:{href:l(n)}}))}),r.appendChild(s)}(),function(){a!==null?r.appendChild(e("a",{className:"pagination-nav pagination-link",html:`${n.NEXT_PAGE} <i class="fa-solid fa-forward"></i>`,attrs:{href:l(a)}})):r.appendChild(e("span",{className:"pagination-nav disabled",html:`${n.NEXT_PAGE} <i class="fa-solid fa-forward"></i>`}))}(),c.replaceChildren(r),c.classList.remove("hidden")}})